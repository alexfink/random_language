---
version: "5.2"

# Also see end of file for more things TODO.

# Probabilistic pre-strippings??  The trouble with this is changing them in diachrony.  I guess one has to change the whole cluster, and make it uninterruptable.
# Coronals shouldn't front vowels, nor labials round them, etc., unless more obvious sources do too.

# fricatives and unvoiced resonants sometimes becoming _aspirated_ stops
# similarly, uvular fricatives sometimes going to [R] sooner than [7_^]

# word-final lengthening.

syllable_template:
  - tag: "peripheral"
    prob: 0.1
    prob_more: 0.166667
    presence: 0.1
    features: "-syllabic"
    
  - tag: onset
    prob: 1
    presence: 0.9
    features: "-syllabic"
    bend: 1

  - tag: onset_resonant
    prob: 0.166667
    presence: 0.142857
    features: "-syllabic +resonant"
    except: 
      "-dorsal -coronal -labial": 0.958333
    reprune: 0.333333

  - tag: glottal
    prob: 0.011111
    presence: 0.25
    features: "-syllabic -dorsal -coronal -labial"

  - tag: glide
    prob: 0.25
    presence: 0.125
    features: "-syllabic +resonant dorsal -nasal -lateral -tap_or_trill"
    reprune: 0.833333
    lump: -1

  - tag: vowel
    prob: 1
    presence: 1
    features: "+syllabic"
    bend: 2 # higher value is weaker bending

  - tag: glide
    prob: 0.25
    presence: 0.142857
    features: "-syllabic +resonant dorsal -nasal -lateral -tap_or_trill"
    reprune: 0.833333
    lump: 1

  - tag: glottal
    prob: 0.033333
    presence: 0.25
    features: "-syllabic -dorsal -coronal -labial"

  - tag: coda_resonant
    prob: 0.166667
    presence: 0.2
    features: "-syllabic +resonant 1 -syllabic +nasal -resonant 1" # this is an or
    except: 
      "-dorsal -coronal -labial": 0.958333
    lump: 1

  - tag: coda
    prob: 0.714286
    presence: 0.4
    features: "-syllabic"

  - tag: peripheral
    prob: 0.1
    prob_more: 0.166667
    presence: 0.1
    features: "-syllabic"

# Note that glottal Cs can be barred from slots in the syllable, by their phonations.



families:
  place: "-syllabic"
  manner: "-syllabic"
  manner_phonation: "-syllabic"
  height: "+syllabic"
  vowel_length: "+syllabic"
  length_height: "+syllabic"

generic_pause_phone: "-syllabic -dorsal -coronal -labial -nasal -voice -spread_glottis -front -back -round -retroflex -pharyngealised"



features:
  - name: syllabic
    structural: true
    generated: []
    default: []

  - name: dorsal
    univalent: true
    families: place height # otherwise height won't get recorded for anything
    generated:
      - {condition: "+syllabic", contrast: 1, prob: 1} # kluge, so we can get heights etc.
      - {condition: "-syllabic", contrast: 1, prob: 0.333333}
    default:
      - {condition: "+syllabic", value: 1}
      - {condition: "", value: 0.05} # sometimes the default place for Cs
    slots:
      peripheral: [0.05, 0.1]

  - name: coronal
    univalent: true
    families: place
    generated:
      - {condition: "-syllabic -dorsal", contrast: 1, prob: 0.666667}
      - {condition: "-syllabic", contrast: 0.0011, prob: 0.333333, prevent_marked: alveolar_velar}
    default:
      - {condition: "dorsal", value: 0}
      - {condition: "", value: 0.05} # sometimes the default place for Cs
    slots:
      peripheral: [0.05, 0.25]
    slot_if_on: "-dorsal"

  - name: labial
    univalent: true
    families: place
    generated:
      - {condition: "-syllabic -dorsal -coronal", contrast: 0.9967, prob: 0.9} # allow the NAm labial-less type
      - {condition: "-syllabic +dorsal", contrast: 0.0909, prob: 0.333333, prevent_marked: labial_velar}
      - {condition: "-syllabic", contrast: 0.0050, prob: 0.333333, prevent_marked: labial_alveolar} # if [tp)] then [kp)]
    default:
      - {condition: "", value: 0}
    slots:
      peripheral: [0.05, 0.1]
    slot_if_on: "-dorsal -coronal"

  # Not sonorant, 'cause nasals aren't included.
  - name: resonant
    families: manner manner_phonation
    generated:
    # TODO: come back to syllabic Cs (assumptions throughout)
      - {condition: "+syllabic", contrast: 1, prob: 1} # another kluge
      - {condition: "-syllabic", contrast: 1, prob: 0.125}
    default:
      - {condition: "+syllabic", value: 1}
      - {condition: "", value: 0.6} # epenthetic /t k/ etc. are much rarer than continuants; and /? h/ are unmarked for resonant in this setup.  besides, features break off as resonants.  even so...
    slots:
      peripheral: [0.9375] # raised against shifts to resonant

  - name: nasal
    families: manner manner_phonation
    generated:
      - {condition: "-syllabic -resonant", contrast: 0.9645, prob: 0.166667}
      - {condition: "-syllabic +resonant", contrast: 0.1777, prob: 0.166667} # hugely cut down by a rule; but having it have some probability is nice for getting nasals that pattern as resonants in phonotactics.  punish extra
      - {condition: "+syllabic", contrast: 0.2262, prob: 0.2}
    default:
      - {condition: "+syllabic", value: 0}
      - {condition: "", value: 0} # if positive, then we have a chance of nasal-only systems!
    slots:
      onset_resonant: [0.75]
      coda_resonant: [0.083333, 0.666667]
      coda: [0, 0.166667]
      peripheral: [0.75]

  - name: prenasalised
    families: manner_phonation
    requires: "-nasal -resonant"
    generated: 
      - {condition: "", contrast: 0.1197, prob: 0.25}
    default:
      - {condition: "", value: 0}
    slots:
      coda: [0.5]
      peripheral: [0.875]

  - name: fricative
    families: manner manner_phonation
    requires: "-resonant"
    generated:
      - {condition: "", contrast: 0.9313, prob: 0.4}
    default:
      - {condition: "+syllabic", value: 1} # the fix to the V > syllabic stop thing
      - {condition: "", value: 0}
    slots:
      coda: [0.125]
      peripheral: [0.083333, 0.333333]

  - name: affricate
    families: manner
      # I have left out manner_phonation because affrication shouldn't be allowed as an extra feature on a phonation-conditioned rule.
    requires: "-fricative -resonant"
    generated:
      - {condition: "", contrast: 0.1109, prob: 0.2} # decreased quite a lot, since most of my affricates are not underlyingly specified thus.  make sure to punish affricates less
    default:
      - {condition: "", value: 0}
    slots:
      coda: [0.125]
      peripheral: [0.25]

  - name: tap_or_trill
    families: manner manner_phonation
    requires: "+resonant"
    generated:
      - {condition: "-syllabic", contrast: 0.1702, prob: 0.5}
    default:
      - {condition: "coronal -lateral", value: 0.75} 
      - {condition: "", value: 0}
    slots:
      onset_resonant: [0, 0, 0.333333]
      coda_resonant: [0, 0, 0.111111]

  # This won't generate the /4 r/ contrast without also having nontaps.
  # /r\/ is often gotten rid of though.
  # What about trilled fricatives?
  - name: trill
    families: manner manner_phonation
    requires: "+resonant +tap_or_trill"
    generated:
      - {condition: "", contrast: 0.3831, prob: 0.5} # kinda inflated, since we rarely make it through to here
    default:
      - {condition: "", value: 0.333333}
    slots:
      onset_resonant: [0, 0, 0.666667]
      coda_resonant: [0, 0, 0.444444]
      coda: [0, 0, 0.222222]

  - name: implosive
    families: manner_phonation
    requires: "-resonant -nasal" # sometimes nasal isn't contrastive :(
    generated:
      - {condition: "", contrast: 0.0881, prob: 0.25} # was 0.1175, 'cause creakiness makes 'em sometimes
    default:
      - {condition: "", value: 0}
    slots:
      coda: [0.333333]
      peripheral: [0.75]

  - name: voice
    families: manner_phonation
    generated:
      - {condition: "-resonant", contrast: 0.7245, prob: 0.375} # minutely amplified 'cause of the modern Greek rule
      - {condition: "+resonant -syllabic", contrast: 0.0444, prob: 0.8, prevent_marked: voiceless_resonant}
      - {condition: "+syllabic", contrast: 0.0033, prob: 0.8}
    forcibly_unmark: 0.75 # TODO: this is worse than something that would sometimes persist into allophony
    default:
      - {condition: "+implosive", value: 1}
      - {condition: "+prenasalised", value: 1}
      - {condition: "-resonant +nasal", value: 1}
      - {condition: "+resonant", value: 1}
      - {condition: "", value: 0} # glottals here
    slots:
      coda: [0, 0, 0.4]
      peripheral: [0, 0, 0.666667]
      onset_resonant: [0, 0, 0.9375]
      coda_resonant: [0, 0, 0.9375]
      glide: [0, 0, 0.9375]

  - name: spread_glottis
    families: manner_phonation
    generated:
      - {condition: "-resonant", contrast: 0.2639, prob: 0.333333}
      - {condition: "", contrast: 0.01, prob: 0.2, prevent_marked: breathy_sonorant}
      - {condition: "+syllabic", contrast: 0.01, prob: 0.2, prevent_marked: breathy_sonorant}
    default:
      - {condition: "", value: 0}
    slots:
      coda: [0.4]
      peripheral: [0.75]
      onset_resonant: [0, 0, 0.9375]
      coda_resonant: [0, 0, 0.9375]
      glide: [0, 0, 0.9375]

  - name: constricted_glottis
    families: manner_phonation
    generated:
      - {condition: "-resonant", contrast: 0.185, prob: 0.333333}
      - {condition: "", contrast: 0.01, prob: 0.2, prevent_marked: creaky_sonorant}
      - {condition: "+syllabic", contrast: 0.01, prob: 0.2, prevent_marked: creaky_sonorant}
    default:
      - {condition: "+implosive +voice", value: 0.9}
      - {condition: "", value: 0}
    slots:
      coda: [0.4]
      peripheral: [0.75]
      onset_resonant: [0, 0, 0.9375]
      coda_resonant: [0, 0, 0.9375]
      glide: [0, 0, 0.9375]

  - name: labiodental
    families: place
    requires: "labial"
    generated:
      - {condition: "", contrast: 0.0025, prob: 0.5}
    forcibly_unmark: 0.95
    default:
      - {condition: "+affricate", value: 0.8}
      - {condition: "+fricative", value: 0.8}
      - {condition: "+resonant", value: 0.2}
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  - name: anterior
    families: place
    requires: "coronal"
    generated: 
      - {condition: "", contrast: 0.3964, prob: 0.666667}
      - {condition: "", contrast: 1, prob: 1} # kluge
    default:
      - {condition: "+fricative", value: 0.95}
      - {condition: "", value: 1}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.333333]

  - name: sibilant
    families: place
    requires: "coronal -resonant"
    generated:
      - {condition: "+anterior", contrast: 0.2, prob: 0.5, by_family_prob: 1, by_family: place, each_family_prob: 0.1} 
    default:
      - {condition: "+affricate", value: 1}
      - {condition: "+fricative", value: 1}
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  # Long is before the vowel features so that vowel qualities can better be
  # generated by families on it.
  - name: long
    families: vowel_length length_height
    generated:
      - {condition: "+syllabic", contrast: 0.1546, prob: 0.222222}
      - {condition: "-syllabic", contrast: 0.0200, prob: 0.166667, by_family_prob: 1, by_family: manner_phonation, each_family_prob: 0.05}
    default:
      - {condition: "", value: 0}
    slots:
      coda: [0.5]
      peripheral: [0.975]
      onset_resonant: [0.9875]
      glide: [0.9875]
      glottal: [0.9875]
      coda_resonant: [0.9875]
    # also remember exceptional geminate mergers, e.g. for affricates, and such as [4r].
    # We may need to ignore certain features (principally secondary articulation) when making longs.  OTOH vowel length on fusing may be better handled by the moraic level.  (fusing rather than dropping is probably right?)
    # http://www.eva.mpg.de/lingua/conference/08_springschool/pdf/course_materials/blevins_evening_lecture.pdf p.17  Also tone! Abramson, HL1336

  - name: low
    families: height length_height
    # I don't put +resonant here because then antithetical filling-in and requirement clearing will conflict.
    requires: "dorsal" 
    antithetical: high
    generated:
      - {condition: "+syllabic", contrast: 1, prob: 0.375, by_family_prob: 0.05, by_family: vowel_length, each_family_prob: 0.5} 
    default:
      - {condition: "+syllabic", value: 0.333333}
      - {condition: "", value: 0}

  - name: high
    families: height length_height place
    requires: "dorsal"
    antithetical: low
    generated:
      - {condition: "+syllabic -low", contrast: 0.799, prob: 0.571429, by_family_prob: 0.25, by_family: vowel_length, each_family_prob: 0.5}
      - {condition: "-syllabic -resonant", contrast: 0.145, prob: 0.5, by_family_prob: 0.5, by_family: manner, each_family_prob: 0.125} # less than UPSID 'cause we sometimes supply -high in fricatives.
      - {condition: "-syllabic +tap_or_trill", contrast: 0.0523, prob: 1} # if uvular trills are gonna exist we may as well embrace them
    default:
      - {condition: "+low", value: 0}
      - {condition: "+fricative", value: 0.85}
      - {condition: "+syllabic", value: 0.95}
      - {condition: "", value: 1}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  - name: front
    families: place
    antithetical: back
    generated:
      - {condition: "+syllabic -low", contrast: 0.9908, prob: 0.5, by_family_prob: 0.05, by_family: height, each_family_prob: 0.5}
      - {condition: "+syllabic", contrast: 0.3, prob: 0.5, by_family_prob: 0.05, by_family: height, each_family_prob: 0.5} # who knows what contrast
      - {condition: "-syllabic dorsal -nasal +resonant", contrast: 0.7878, prob: 0.571428}
      - {condition: "-syllabic dorsal", contrast: 0.1429, prob: 0.3, by_family_prob: 0.25, by_family: manner, each_family_prob: 0.125} # inflated some?
      - {condition: "-syllabic", contrast: 0.0776, prob: 0.3, by_family_prob: 0.8, by_family: place, each_family_prob: 0.333333}
    default:
      - {condition: "+low", value: 0.1}
      - {condition: "+syllabic", value: 0.625}
      - {condition: "-syllabic +resonant dorsal", value: 0.6} # hopefully this cuts down on /w/
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  - name: palatalised_velar
    families: place
    requires: "dorsal -resonant"
    generated:
      - {condition: "+front", contrast: 0.005, prob: 0.5}
    default:
      - {condition: "+front", value: 0.142857}
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  - name: round
    families: place
    generated:
      - {condition: "+syllabic -front", contrast: 0.2439, prob: 0.666667, by_family_prob: 0.333333, by_family: height, each_family_prob: 0.5, prevent_marked: back_unrounded}
      - {condition: "+syllabic +front", contrast: 0.1020, prob: 0.2, by_family_prob: 0.333333, by_family: height, each_family_prob: 0.5, prevent_marked: front_rounded}
      - {condition: "-syllabic dorsal -front", contrast: 0.1663, prob: 0.333333}
      - {condition: "-syllabic", contrast: 0.0148, prob: 0.2, by_family_prob: 0.833333, by_family: place, each_family_prob: 0.25}
    default:
      - {condition: "+lateral", value: 0} # bit ugly eh
      - {condition: "+tap_or_trill", value: 0}
      - {condition: "-syllabic +resonant dorsal -front", value: 1} # I don't think this is the right place to try to cut down /w/ frequency
      - {condition: "+resonant dorsal -front -low", value: 1}
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  - name: back
    families: place
    antithetical: front
    generated:
      - {condition: "+syllabic -front", contrast: 0.0288, prob: 0.25, by_family_prob: 0.333333, by_family: height, each_family_prob: 0.5}
    default:
      # complicated but perhaps necessary
      - {condition: "+low", value: 0.2}
      - {condition: "+syllabic dorsal -front -round", value: 0.5}
      - {condition: "dorsal -front", value: 1}
      - {condition: "dorsal -resonant", value: 1}
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  - name: ATR
    families: height
    requires: "+resonant dorsal" # best we can do using features guaranteed to be there
    generated:
      - {condition: "+syllabic", contrast: 0.1759, prob: 0.5, by_family_prob: 0.5, by_family: length_height, each_family_prob: 0.5}
    default:
      - {condition: "+low", value: 0}
      - {condition: "+syllabic -high", value: 0.5}
      - {condition: "", value: 1}

  - name: lateral
    families: place
    generated:
      - {condition: "+resonant -syllabic", contrast: 0.6123, prob: 0.5, by_family_prob: 0.8, by_family: place, each_family_prob: 0.333333}
      - {condition: "-resonant", contrast: 0.1043, prob: 0.25, by_family_prob: 1, by_family: place, each_family_prob: 0.05} # turned up then down some
      # Is selective removal of these in sound change the way we mean to get things like [K] > [l] without corresponding damage to other fricatives?
    default:
      - {condition: "coronal +resonant", value: 0.5}
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.05]
      peripheral: [0, 0, 0.4]

  - name: retroflex
    families: place
    generated:
      - {condition: "-anterior", contrast: 0.1041, prob: 0.5}
      - {condition: "+syllabic", contrast: 0.0089, prob: 0.166667, by_family_prob: 0.75, by_family: height, each_family_prob: 0.2}
    default:
      - {condition: "-anterior", value: 0.1}
      - {condition: "", value: 0}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  # Versions prior to v4 had a dental-alveolar distinction
  # in place of the current apical-laminal distinction.  Dental vs. alveolar
  # is not really the relevant thing:
  # http://listserv.brown.edu/archives/cgi-bin/wa?A2=ind1009b&L=conlang&T=0&F=&S=&P=4490

  # "Dentals" are laminal, most "alveolars" are apical (but "dentialveolars" are laminal).  
  # Retroflexes can have either position; I'm not sure if one is more typical.
  # Usual postalveolars are laminal; palatalised ones are only attested laminal.

  - name: laminal
    families: place
    requires: "coronal"
    generated:
      - {condition: "+anterior", contrast: 0.0129, prob: 0.5, by_family_prob: 0.666667, by_family: manner, each_family_prob: 0.333333} # langs like Toda distinguish two retroflexes (i.e. non-domed postalveolars), one laminal and one *sub*apical.  no idea about the prob though
    forcibly_unmark: 0.9871
    default: # subject to revision
      - {condition: "+retroflex", value: 0.166667}
      - {condition: "-anterior", value: 0.916667}
      - {condition: "", value: 0.333333}
    slots:
      coda: [0, 0, 0.125]
      peripheral: [0, 0, 0.5]

  - name: pharyngealised
    families: place
    generated:
      - {condition: "-syllabic", contrast: 0.0227, prob: 0.2, by_family_prob: 1, by_family: place, each_family_prob: 0.2}
      - {condition: "+syllabic", contrast: 0.0200, prob: 0.2}
    default:
      - {condition: "", value: 0}



strippings:
  # It seems that voiceless zero ought to be [h].  
  # That means the ordering here is very crucial, which in turn means
  # we need to be careful when using this for pushing.
  - condition: "-dorsal -coronal -labial"
    priority: 1
    substitute:       # hack for an ordered hash
      - "-fricative -nasal: +constricted_glottis"
      - "-voice -constricted_glottis: +spread_glottis"
    strip: "resonant prenasalised implosive fricative affricate lateral tap_or_trill trill retroflex"



# best to avoid putting structural features in a relation...
relations:
  # GOTCHA: in fact, the following two are _uninvokable_ right now.
  # I think [h] > [x] shd be treated as generally an option
  - from: "-dorsal -coronal -labial +spread_glottis"
    to: "dorsal +fricative"
    weight: 0.083333

  # [?] <> [h] variation is found, a little.
  - from: "-dorsal -coronal -labial +constricted_glottis"
    to: "-dorsal -coronal -labial +spread_glottis"
    weight: 0.0625
    twoway: true

  # In lieu of a dorsal <> coronal rule, we include various special cases.  
  # There are things like the Polynesian [t] > [k] gapfilling, or the same 
  # in southern Athabaskan, or the [p] > [k] elsewhere in America somewhere,
  # but I believe these are always gap-fillings.
  - from: "coronal +resonant"
    to: "dorsal"
    weight: 0.666667

  # even straight [s] > [x] is not unheard of
  - from: "coronal +fricative"
    to: "dorsal"
    weight: 0.083333

  - from: "dorsal +nasal -resonant"
    to: "coronal"
    weight: 2

  - from: "dorsal +resonant"
    to: "coronal -dorsal"
    weight: 0.125

  # [5] > [w] is highly favoured.  But this rule doesn't achieve that itself...
  - from: "coronal +resonant +lateral +back"
    to: "+round"
    weight: 3

  # I had a rule to bump up the probabilities a little so that
  # dorsal is closest to radical.  But I deleted it.
  # We'll put that in properly when shift probabilities come up.

  # TODO: when we get to unconditioned shifting, we should not shift
  # voiceless fricatives to resonants with anything _close_ to this probability.
  - from: "+fricative"
    to: "+resonant"
    weight: 2
    twoway: true

  # TODO: on the other hand, sometimes glottals are less stable in clusters

  # TODO: that general intervocalic placelessising 
  # (sometimes all postvocalic, or even broader?)
  # with many potential possible targets, but nearly always a small set.  
  # Dorsals and coronals should be the specially susceptible PoAs, but
  # nearly always just one of them;
  # affricates shd probably not be susceptible at all; etc.

  - from: "+nasal"
    to: "+resonant"
    weight: 1

  - from: "+resonant"
    to: "+nasal"
    weight: 0.2

  - from: "+prenasalised"
    to: "+nasal"
    weight: 1

  - from: "+nasal -resonant"
    to: "+prenasalised"
    weight: 0.066667

  # TODO: if prenasals get special simplification rules like the above, what for other complex segment types?  Frankly I think it would be sensibler not to implement those as single segments.  But consider this for affricates.

  - from: "+affricate"
    to: "+fricative"
    weight: 2

  # this is useful for some rules ... but at this weight, how will it
  # ever dominate just flipping fricative?  well, that'll be less likely
  # as an unconditioned change.
  - from: "+fricative" 
    to: "+affricate"
    weight: 0.166667

  # This rule is only here 'cause [ts)] > [t] type things are conspired against
  # without it.
  - from: "coronal +affricate"
    to: "-affricate -sibilant -lateral"
    weight: 0.333333

  - from: "+spread_glottis -voice -resonant"
    to: "+affricate"
    weight: 0.666667

  - from: "+fricative"
    to: "-dorsal -coronal -labial"
    weight: 0.5

  # ditto voiceless nasals 
  - from: "+nasal -voice"
    to: "-dorsal -coronal -labial"
    weight: 0.5

  - from: "+implosive"
    to: "+resonant"
    weight: 0.1875

  - from: "+implosive"
    to: "+nasal"
    weight: 0.375

  - from: "-dorsal -coronal -labial" # rhinoglottophilia
    to: "+nasal"
    weight: 0.5

  - from: "dorsal +resonant -lateral -tap_or_trill +spread_glottis" # rhinoglottophilia, single-segment type
    to: "dorsal +resonant -lateral -tap_or_trill +nasal"
    twoway: true
    weight: 0.166667

  - from: "dorsal -resonant -high"
    to: "-dorsal"
    weight: 1 # for uvulars falling

  - from: "dorsal +front"
    to: "coronal -dorsal -anterior -retroflex +laminal"
    weight: 3

  - from: "+front" # less common for other places
    to: "dorsal"
    weight: 0.5

  - from: "+front coronal"
    to: "-anterior -retroflex"
    weight: 2.5

  - from: "+front coronal"
    to: "+laminal"
    weight: 0.75
    twoway: true

  # bizarrely, the correlation with the opposite feature seems to exist too!  
  # e.g. compare the dialectal Albanian and Mull/Islay [5] ~ [D] type exchanges; and Scots or is it Irish [t_j] vs. [t_d_G].  
  - from: "+back +anterior"
    to: "+laminal"
    weight: 0.333333

  # it at least seems likely that [s_m s_a] would push to [T s].
  - from: "+sibilant +anterior +laminal"
    to: "-sibilant"
    weight: 0.25

  # TODO: I think this one should only really be common for non-stops?
  - from: "+back"
    to: "dorsal"
    weight: 1

  # This is problems waiting to happen: it means that if we have
  # rules invoking -anterior -retroflex but not specifying resonancy,
  # this pair of rules won't take effect.
  - from: "-anterior -retroflex -resonant"
    to: "dorsal -coronal +front -palatalised_velar"
    weight: 2

  - from: "-anterior -retroflex +resonant"
    to: "dorsal -coronal +front -tap_or_trill"
      # else [r] > [R] before [tS)] happens.  Since this caters only
      # to the postalveolars, it's okay to exclude it here.
    weight: 2

  # The main thing distinguishing [k_j] from [c] here is that when
  # the former gets unpalatalised, it reverts to [k].
  # (If not for this there'd be no reason to support the feature on non-front.)
  - from: "+palatalised_velar -front"
    to: "dorsal -resonant +back"
    weight: 4

  # a labial effect of fronting.  TODO: when linguolabials are in, rethink this and the next couple
  - from: "labial +front"
    to: "+labiodental"
    weight: 0.25

  # Ohala says palatalised labials becoming coronals is common.  but _these_ coronals?
  - from: "labial +front"
    to: "+anterior -sibilant +fricative +laminal"
    weight: 0.125

  # [T] > [f]
  - from: "+anterior -sibilant +fricative" # Blevins suggests laminal only
    to: "+labiodental -coronal"
    weight: 0.666667

  # Are there ever cases of retroflexes colouring all the way through to the back, or is this a subsequent change?
  - from: "+retroflex"
    to: "-front"
    weight: 1

  # manifestations of flatness
  # this first one is probably the main ingredient in ruki-oid rules, and many rules that look like [S] > [x]
  - from: "-anterior +retroflex"
    to: "coronal +back"
    weight: 0.25
    twoway: true

  - from: "-anterior +retroflex"
    to: "coronal +round"
    weight: 0.125
    twoway: true

  - from: "-anterior +retroflex"
    to: "coronal +pharyngealised"
    weight: 0.1255
    twoway: true

  # and the last repeated for vowels.  
  - from: "+retroflex dorsal +resonant -lateral -tap_or_trill"
    to: "+pharyngealised dorsal +resonant -lateral -tap_or_trill"
    weight: 0.125
    twoway: true

  # "Laryngealised" voiced sounds are what I know better as creaky.  But it's less clear what it means on something voiceless (though Blevins explains) -- I think it's what faucalisation would be, though.  In at least some examples even UPSID voiceless laryngealised sounds are grouped with ejectives elsewhere.  
  - from: "+constricted_glottis"
    to: "+pharyngealised"
    weight: 0.033333
    twoway: true

  # If [w] is ever grabbed individually, this should make a labial
  # resolution very likely for it.  Thing is, it's often grabbed
  # together with [j] at least, and so this is hard to achieve.
  # On the other hand, one hopes that occasionally [w] just gets caught
  # up in this and then the labial resonant hardens.
  - from: "+round -syllabic"
    to: "labial -labiodental"
    weight: 3 # high since this has to work with the coarticulate resolution rule

  # Tropylium says the only categorical examples of labial > velar he knows are for rounded labials and linguolabials.
  # (But isn't there a dialectal Slavic [f] > [xv]?  eh, get it as a composition.)
  # We make them go to labio-velars.
  - from: "labial +round"
    to: "dorsal +back" 
    weight: 1

  # [B\] often has developed from [bu] or [mb)u]
  - from: "labial -resonant +voice +round"
    to: "+trill -round"
    weight: 0.5 # highish 'cause seems unlikelyish to be invokable

  - from: "labial +resonant"
    to: "dorsal +back +round" 
    weight: 3

  # Coarticulates > secondary articulations.
  # Just for labial now.  Dorsal can also drop leaving fronting and backing,
  # but that doesn't need its own rule.
  - from: "dorsal labial"
    to: "+round -labial"
    weight: 0.666667

  - from: "coronal labial"
    to: "+round -labial"
    weight: 0.666667

  - from: "+pharyngealised"
    to: "-ATR"
    weight: 0.4
    twoway: true

  # hm, is this correct for consonants?
  - from: "+pharyngealised"
    to: "+back"
    weight: 0.1
    twoway: true

  - from: "+pharyngealised -high"
    to: "+low"
    weight: 0.5

  - from: "+low"
    to: "+pharyngealised"
    weight: 0.05

  - from: "+low -resonant" # in the hopes of getting [X] > [X\] type shifts from 'lowering'
    to: "+pharyngealised -dorsal"
    weight: 2.5

  - from: "+low +tap_or_trill" # ditto for [R\]
    to: "+pharyngealised -dorsal"
    weight: 2.5

  # this has good effects on Cs and Vs
  - from: "+pharyngealised"
    to: "-high"
    weight: 2

  - from: "-dorsal +pharyngealised -syllabic"
    to: "+dorsal -high -syllabic" # though we really want +low here!
    weight: 0.5
    twoway: true
    # will this still work when epiglottal trill is in?

  - from: "+implosive"
    to: "+constricted_glottis"
    weight: 0.5
    twoway: true

  - from: "-affricate"
    to: "-trill"
    weight: 0.6
    twoway: true

  - from: "-resonant dorsal -high +voice"
    to: "+tap_or_trill"
    weight: 1.5

  # do we need a 'fortis' pseudo-feature, or a 'lenis' one?
  # no, I imagine we can make do, though it might mean duplication
  # in the outcomes of length and strong position

  - from: "-lateral coronal +resonant"
    to: "-anterior +retroflex"
    weight: 0.333333

  - from: "+long +tap_or_trill"
    to: "+trill"
    weight: 4

  # Long vowels have a tendency to rise.  In four movements.
  # TODO: these probably shouldn't be relations as much as wandering-frequencies, when we get there.  Also [3:] > [a:] shd be favoured.
#  - from: "+long +low +front"
#    to: "-low"
#    weight: 1
#
#  - from: "+long +low +back"
#    to: "-low"
#    weight: 1
#
#  - from: "+long -low -high"
#    to: "+high"
#    weight: 1
#
#  - from: "+long -low -ATR"
#    to: "+ATR"
#    weight: 1

  - from: "+syllabic -long"
    to: "-ATR"
    weight: 1

  # Low vowels seem to be predisposed to unconditioned shifts to long,
  # especially by way of amplifying [a:] vs. [6] type contrasts,
  # but also e.g. Swedish unconditioned [a] > [a:].  
  - from: "+low +syllabic" # hope that's not trouble...
    to: "+long"
    weight: 0.125

  # Creaky lowers, breathy raises, for formant reasons.  This is found in Khmer.  See Thurgood.  For ATR, Wikipedia says something.  But also note the lowering near [h] below.  
  # TODO: diphthongisation with these only effecting the early part of the vowel is common.  So, breakings.
  - from: "+voice +spread_glottis -ATR"
    to: "+ATR"
    weight: 0.75
  - from: "+voice +spread_glottis -high -low"
    to: "+high"
    weight: 0.25
  - from: "+voice +spread_glottis +low"
    to: "-low"
    weight: 0.25

  - from: "+voice +constricted_glottis +ATR"
    to: "-ATR"
    weight: 0.75
  - from: "+voice +constricted_glottis +high"
    to: "-high"
    weight: 0.25
  - from: "+voice +constricted_glottis -high -low"
    to: "+low"
    weight: 0.25

  # pinch at the [i] corner of the vowel space: [1] and [I] are close
  - from: "+high -front -back"
    to: "+high +front -ATR"
    weight: 0.333333

  - from: "+high -ATR"
    to: "+high -front -back"
    weight: 0.111111

  - from: "+front +round +syllabic" # trouble?
    to: "-front -back -round +syllabic"
    weight: 0.05
    twoway: true

  - from: "+back -round +syllabic"
    to: "-front -back +round +syllabic"
    weight: 0.05
    twoway: true

  - from: "+high -ATR"
    to: "-high -low +ATR"
    weight: 1.5
    twoway: true

  - from: "-front -back"
    to: "+back"
    weight: 0.5
    twoway: true

  - from: "-back -front"
    to: "+front"
    weight: 0.5
    twoway: true

  - from: "-low -high"
    to: "+high"
    weight: 0.5
    twoway: true

  - from: "-high -low"
    to: "+low"
    weight: 0.5
    twoway: true



marked:
  # We begin with the sequences, assimilations &c.

  # this is the big nasal &c place assimilation change
  - condition: "-resonant, -syllabic"
    except: {1: "-dorsal -coronal -labial"}
    prob: 0.925
    extras: {"-resonant 1": 0.933333, "!+resonant +lateral 1": 0.95, "!+tap_or_trill 1": 0.95, "+nasal 0": 0.966667, "-fricative 0": 0.833333, "!+sibilant 0": 0.5, "-nasal 1": 0.25, "coronal -sibilant 0": 0.181818, "# 1": 0.014815}
      # nonsibilant coronal closures are less detectable before a C.
    pause_phone: "-dorsal -coronal -labial" 
    resolve: {"r >dorsal >coronal >labial >front >back >round >retroflex >labiodental >anterior >laminal >high >palatalised_velar >pharyngealised -affricate 0": 1}
      # always make nonaffricate; else we get like [ts)p] > [fp]

  # TODO: check that this gets correctly repaired for nasals.  Ultimately they should either have already spread nasalisation or get repaired to /N/ or velar nasal glide, but usually not simply vanish.  

  # TODO: complete stop place assimilation shd be less frequent, compared to place-sensitive versions, than this is.  
  # Blust 1979: in fact, coronal+non-coronal clusters are more likely to assimilate, or metathesise the coronal before Resonants, than others.  But sibilants are the other way; these are distinctive, and so they metathesise into less salient positions: KsR > sKR, sK(#,O) > Ks(#,O), where K is an obstruent (Steriade 2001).  From Hayes-Kirchner-Steriade [pk] > [kp] is also there. 
  # I've also seen [sk] > [st] I think more or less unconditioned; is sibilancy strong enough to do this sometimes?
  # What about funny [p] <> [k] before [t]?  What's the auditory basis?  Does it have structural prerequisites?
  # and a form of place dissimilation, [tl] > [kl] vel sim
  # TODO: [t] > [ts)] before stops is also a strategy, but it belongs thematically with stop+stop > fric+stop.

  # a repeat, for extra weight of [t] assimilating before things where other stops don't
  - condition: "-nasal coronal -fricative -resonant, -syllabic"
    except: {1: "-dorsal -coronal -labial"}
    prob: 0.1
    extras: {"-resonant 1": 0.875, "!+sibilant 0": 0.5, "-nasal 1": 0.166667, "coronal -sibilant 0": 0.181818, "# 1": 0.25} 
    pause_phone: "-dorsal -coronal -labial" 
    resolve: {"r >dorsal >coronal >labial >front >back >round >retroflex >labiodental >anterior >laminal >high >palatalised_velar -affricate 0": 1}

  # rightward place assimilation, like w/ German CN=.
  - condition: "-syllabic, -resonant, -syllabic -resonant"
    except: {0: "-dorsal -coronal -labial"}
    prob: 0.125
    extras: {"# 2": 1, "-resonant 0": 0.966667, "+nasal 1": 0.833333, "-fricative 1": 0.833333, "!+sibilant 1": 0.5} 
    resolve: {"r <dorsal <coronal <labial <front <back <round <retroflex <labiodental <anterior <laminal <high <palatalised_velar -affricate 1": 1}

  # make sequences like [ts\)c cts\)] totally assimilate.
  - condition: "-resonant dorsal +front, -resonant coronal -anterior -retroflex"
    prob: 0.75
    direction: {"": 1, reverse: 0.125, both: 0.375}
    resolve: {"r >dorsal >coronal >anterior 0": 1}

  # not unified, 'cause the or would be ugly
  - condition: "-resonant coronal -anterior -retroflex, -resonant dorsal +front"
    prob: 0.75
    extras: {"+front 0": 0.5}
    direction: {"": 1, reverse: 0.125, both: 0.375}
    resolve: {"r >dorsal >coronal >anterior >front -affricate 0": 1}

  # velar coarticulate formation
  - condition: "-resonant, -syllabic"
    except: {0: "-coronal -labial", 1: "-dorsal -coronal -labial"}
    prob: 0.1875 # larger than its counterpart 'cause labvel > lab more
    contrast_probs:
      "dorsal -labial, dorsal +labial": 0.8
      "dorsal -coronal, dorsal +coronal": 0.8
    extras: {"labial 0": 0.5, "-resonant 1": 0.125, "# 1": 0.333333}
    pause_phone: "-dorsal" 
    resolve: {"r >dorsal >front >back >high >palatalised_velar 0": 1}

  # labial coarticulate formation
  - condition: "-resonant, -syllabic"
    except: {0: "-dorsal -coronal", 1: "-dorsal -coronal -labial"}
    prob: 0.09375
    contrast_probs:
      "+dorsal labial, -dorsal labial": 0.8
      "+coronal labial, -coronal labial": 0.8
    extras: {"dorsal 0": 0.5, "-resonant 1": 0.125, "# 1": 0.333333}
    pause_phone: "-labial" 
    resolve: {"r >labial >labiodental 0": 1}

  # Collapse of grave places before a coronal.
  - condition: "-resonant, coronal -resonant"
    except: {0: "-dorsal -labial"}
    prob: 0.037037
    extras: {"+fricative 0": 0.5}
    resolve: {"r dorsal -labial 0": 1, "r -dorsal labial 0": 1}

  # intervocalic fricative lenition
  - condition: "dorsal +resonant -lateral -tap_or_trill, +fricative -long, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.075
    extras: {"+voice 1": 0.975, "!+sibilant +anterior 1": 0.25}
    resolve: {"r +resonant 1": 1}

  # to tie labial fricatives to labialisation more.  TODO: other places
  - condition: "-resonant, labial +fricative"
    prob: 0.041667
    direction: {"": 1, reverse: 0.0625, both: 0.125}
    extras: {"-nasal 0": 0.666667, "-labial 0": 0.333333}
    resolve: {"r +resonant 1": 1}

  # _Homorganic_ resonant spread rules exist; that's a good model for this [ln] > [ll] type behaviour.  But I haven't done it for dorsal, 'cause semivowels are the overwhelmingly dominant resonant there.
  # TODO: recast these as homorganicity rules.
  # The "+voice" extra here is a little weird given that unvoiced resonants do exist...
  - condition: "coronal +resonant, coronal"
    prob: 0.19
    extras: {"+voice 1": 0.875, "+nasal 1": 0.4, "+fricative 1": 0.25, "-tap_or_trill 0": 0.666667}
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r +resonant <nasal <lateral <tap_or_trill 1": 1}

  - condition: "labial +resonant, labial"
    prob: 0.19
    extras: {"+voice 1": 0.875, "+nasal 1": 0.4, "+fricative 1": 0.25, "-tap_or_trill 0": 0.666667}
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r +resonant <nasal <lateral <tap_or_trill 1": 1}

  # most resonants can metathesise, but I don't think there's a natural change at a distance here

  - condition: "-resonant, "
    prob: 0.06
    extras: {"-resonant 1": 0.5, "+voice 0": 0.5, "!+resonant -nasal 1": 0.975, "+nasal 1": 0.857143}
    resolve: {"r >nasal 0": 1}

  - condition: ", -resonant"
    prob: 0.04
    extras: {"-resonant 0": 0.5, "+voice 1": 0.5, "!+resonant -nasal 0": 0.975, "+nasal 0": 0.5, "-nasal 0": 0.25} # different +nasal 0 prob.  remember, - overwrites later
    resolve: {"r <nasal 1": 1}

  # special nasal > resonant after nonnasal
  - condition: "-nasal, +nasal"
    except: {0: "dorsal +resonant -lateral -tap_or_trill"}
    prob: 0.045
    extras: {"-syllabic 1": 0.875, "-resonant 0": 0.833333, "+fricative 0": 0.166667, "!-labial -dorsal 1": 0.2}
    resolve: {"r +resonant 1": 1}

  - condition: ", +nasal"
    except: {0: "-resonant"} # for radicals
    prob: 0.3875
    extras: {"+resonant 1": 0.333333, "+syllabic 0": 0.75, "dorsal -lateral -tap_or_trill 0": 0.666667, "!-syllabic +resonant 0": 0.2}
    direction: {"": 0.315, reverse: 0.0875, both: 0.045}
    resolve: {"r +nasal 0": 1}

  # TODO: there was a nasal assimilation change here, but it wasn't very good.  Really what we just want is some kind of total assimilation among sonorants, often constrained to the same POA.  (What about syllabics?  Surely [in] > [n=n] is freak.)
  # Given homorganicity, should (C or V) epenthesis be an option of this change as well?  Should the primary locus of those things be elsewhere?

  # *[ns] etc.
  - condition: "+nasal -syllabic, -syllabic"
    except: {1: "-fricative"}
    prob: 0.142857
    extras: {"+fricative 1": 0.857143, "!+resonant 1": 0.5, "!dorsal +resonant -lateral -tap_or_trill 1": 0.75}
    resolve: 
      "r -dorsal -coronal -labial 0": 1
      "r -resonant -fricative 1": 1
      # TODO: epenthesis!

  - condition: ", +nasal"
    extras: {"-resonant 0": 0.9, "+voice 0": 0.95, "-dorsal 0": 0.2, "labial 0": 0.2}
    filter:
      condition: "-syllabic"
      extras: {"!dorsal +resonant -lateral -tap_or_trill 0": 0.833333}
    prob: 0.0125
    contrast_probs:
      "+syllabic -nasal, +syllabic +nasal": 0
    resolve: {"r +nasal 0": 1}
  # Same up to direction except for the PoA conditions.  Not unified for that reason.
  - condition: "+nasal, "
    extras: {"-resonant 0": 0.9, "+voice 0": 0.95}
    filter:
      condition: "-syllabic"
      extras: {"!dorsal +resonant -lateral -tap_or_trill 0": 0.833333}
    prob: 0.00625
    contrast_probs:
      "+syllabic -nasal, +syllabic +nasal": 0
    resolve: {"r +nasal 1": 1}

  - condition: ", +nasal"
    filter:
      condition: "+syllabic"
    prob: 0.05 # in this case the contrast_prob is nearly always invoked
    contrast_probs:
      "-syllabic -nasal, -syllabic +nasal": 0.003333 # a little
    direction: {"": 1, reverse: 1, both: 2}
    resolve: {"r +nasal 0": 1}

  # nasal dissimilation (e.g. in Spanish sequences).  assim (DONE) and dissim at a distance

  # fricative dissimilation is a big one.  also the [Cs] ~ [Cts)] type behaviours.  
  # Howe has assimilation too in C clusters.  "bidness"

  # affricate dissimilation to stable stops (-sibilant -lateral) at a distance (e.g. Mingrelian, Moroccan Arabic), though also even in like [ts)Vs]

  - condition: "coronal, coronal"
    further_features: trill lateral
    prob: 0.333333
    resolve: {"r }tap_or_trill 0": 1}

  - condition: "+spread_glottis -voice, -long"
    prob: 0.15
    extras: {"-syllabic 1": 0.95, "!-high 1": 0.4, "-nasal 1": 0.833333} # really should just be prevented in prominent positions
    resolve: {"r -voice 1": 1}

  - condition: "-long, +spread_glottis -voice"
    prob: 0.15
    extras: {"-dorsal -coronal -labial 1": 0.975, "!-high 0": 0.4, "-syllabic 0": 0.5, "-nasal 0": 0.833333} # prominence?
    resolve: {"r -voice 0": 1}

  - condition: "-syllabic, "
    except: {1: "+voice +resonant"}
    prob: 0.727273
    extras: {"-syllabic 1": 0.95, "-resonant -nasal 0": 0.75, "-nasal 0": 0.75, "!+resonant 1": 0.333333, "-resonant 1": 0.375, "-nasal 1": 0.75, "# 1": 0.4, "-fricative 0": 0.1, "!dorsal +resonant -lateral -tap_or_trill 0": 0.4} # Blevins: sometimes fricatives are voice-distinguished by their noisiness
    pause_phone: "-voice"
    resolve: {"r }voice 0": 1}

  - condition: ", -syllabic"
    except: {0: "+voice +resonant"}
    prob: 0.555556
    extras: {"-syllabic 0": 0.95, "!+resonant 0": 0.333333, "-resonant 0": 0.375, "-nasal 0": 0.875, "+nasal 0": 0.142857, "-resonant -nasal 1": 0.6, "-nasal 1": 0.333333, "+resonant 1": 0.666667, "-spread_glottis 1": 0.5, "-constricted_glottis 1": 0.5, "# 0": 0.005} # +resonant is high because -resonant -nasal will usually knock it out
    resolve: {"r {voice 1": 1}

  # Much frequenter voice assimilation of all C _if_ voice is contrastive on resonants.
  - condition: "-syllabic, "
    except: {1: "+resonant"}
    prob: 0.005
    contrast_probs:
      "+resonant +voice, +resonant -voice": 0.95
      # nasals too...  that's usually generated but destroyed though
    extras: {"-syllabic 1": 0.95, "-resonant 1": 0.375, "# 1": 0.4}
    pause_phone: "-voice"
    resolve: {"r }voice 0": 1}

  - condition: ", -syllabic"
    except: {0: "+resonant"}
    prob: 0.001667
    contrast_probs:
      "+resonant +voice, +resonant -voice": 0.95
      # nasals too, as above
    extras: {"-syllabic 0": 0.95, "-resonant 0": 0.375, "# 0": 0.02}
    pause_phone: "-voice"
    resolve: {"r {voice 1": 1}

  # next sequential voicings, which can include vowels
  - condition: "+voice, -voice -long, +voice" 
    prob: 0.1
    extras: {"+resonant 1": 0.166667, "+fricative 1": 0.5, "-fricative 1": 0.1, "-spread_glottis 1": 0.975, "-constricted_glottis 1": 0.975, "# 2": 0.025}
    resolve: {"r +voice 1": 1}
  # TODO: put prominence in these vowel devoicing changes.  ??add epenthesis-style for long V to the second

  - condition: "-voice, +voice -long, -voice" 
    prob: 0.05
    # should be mostly prevented for stressed vowels
    # and should there really be conditioning on V height here?  it's also elsewhere
    extras: {"# 0": 0.666667, "## 0": 0.25, "# 2": 0.666667, "## 2": 0.25, "-nasal 1": 0.75, "!-high 1": 0.666667, "!+low 1": 0.5} 
    pause_phone: "-voice"
    resolve: {"r -voice 1": 1}

  - condition: "+voice +syllabic -long, -voice +spread_glottis -coronal -dorsal -labial" # what about vl fricatives?
    prob: 0.02
    resolve: {"r -voice 0": 1}
  # TODO: voiceless V can in fact devoice Cs

  # breathiness here, and creakiness below, are very unlikely to spread
  # _from_ a vowel, per Blevins
  - condition: "+voice, +voice"
    prob: 0.75
    extras: {"+resonant dorsal -lateral -tap_or_trill 0": 0.333333, "+spread_glottis 1": 0.9375, "-syllabic 1": 0.9875} # can't get nasals but not stops this way.  problem?
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r }spread_glottis 0": 1}

  - condition: "-resonant, -dorsal -coronal -labial +spread_glottis"
    prob: 0.52
    extras: {"-nasal 0": 0.975, "+voice 0": 0.5, "-voice 0": 0.333333}
    direction: {"": 1, reverse: 0.5, both: 1}
    resolve: {"r +spread_glottis 0": 1}

  - condition: "-resonant, "
    except: {1: "+resonant"}
    prob: 0.6
    extras: {"-nasal 0": 0.975, "# 1": 0.25}
    pause_phone: "-spread_glottis 11 +spread_glottis 1"
    resolve: 
      "r }spread_glottis 0": 0.5
      "r -spread_glottis 0": 0.125 # sometimes just neutralise
      "r +spread_glottis 0": 0.011364

  - condition: ", -resonant"
    except: {0: "+resonant"}
    prob: 0.6
    extras: {"-nasal 1": 0.975, "+spread_glottis 0": 0.666667}
    resolve: {"r {spread_glottis 1": 1}
  # this is a little weird though; we expect aspiration not to be there so much before an obstruent.

  - condition: "-resonant, +fricative -voice"
    prob: 0.025
    extras: {"-nasal 0": 0.975, "+voice 0": 0.5, "-voice 0": 0.333333}
    direction: {"": 1, reverse: 0.5, both: 0.5}
    resolve: {"r +spread_glottis 0": 1}

  - condition: ", +spread_glottis"
    extras: {"-fricative -nasal 0": 0.5}
    filter:
      condition: "-syllabic"
      extras: {"!dorsal +resonant -lateral -tap_or_trill 0": 0.833333, "-resonant 0": 0.166667, "-fricative -nasal 0": 0.083333}
    prob: 0.02 # only relevant if +spread exist
    contrast_probs:
      "+syllabic -voice, +syllabic +voice": 0
      "+syllabic -spread_glottis, +syllabic +spread_glottis": 0
    direction: {"": 1, reverse: 0.5, both: 0.5}
    resolve: {"r +spread_glottis 0": 1}
  # spread glottis at a distance (DONE), dissimilation at a distance

  - condition: ", +spread_glottis"
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.5}
    prob: 0.02 # only relevant if +spread exist
    contrast_probs:
      "-syllabic -spread_glottis, -syllabic +spread_glottis": 0
    direction: {"": 1, reverse: 0.5, both: 1.5}
    resolve: {"r +spread_glottis 0": 1}

  - condition: "+voice, +voice"
    prob: 0.65
    extras: {"+resonant dorsal -lateral -tap_or_trill 0": 0.333333, "+constricted_glottis 1": 0.9375, "-syllabic 1": 0.9875}
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r }constricted_glottis 0": 1}

  - condition: "-resonant, -dorsal -coronal -labial +constricted_glottis"
    prob: 0.377778
    extras: {"-nasal 0": 0.875, "+voice 0": 0.5, "-voice 0": 0.333333}
    direction: {"": 1, reverse: 0.2, both: 0.2}
    resolve: {"r +constricted_glottis 0": 1}

  - condition: "+voice, "
    prob: 0.1875
    extras: {"-dorsal -coronal -labial 1": 0.5, "!-nasal -resonant 0": 0.333333, "+resonant 0": 0.333333, "+resonant dorsal -lateral -tap_or_trill 0": 0.5, "+constricted_glottis 1": 0.925}
    resolve: {"r }constricted_glottis 0": 1}

  - condition: "-dorsal -coronal -labial, +voice"
    prob: 0.025
    extras: {"!-nasal -resonant 1": 0.333333, "+resonant 1": 0.333333, "+resonant dorsal -lateral -tap_or_trill 1": 0.5, "+constricted_glottis 0": 0.875}
    resolve: {"r {constricted_glottis 1": 1}

  - condition: "-resonant -nasal, "
    except: {1: "+resonant"}
    prob: 0.6
    extras: {"-nasal 1": 0.9, "# 1": 0.125}
    pause_phone: "-constricted_glottis 6 +constricted_glottis 1"
    resolve: 
      "r }constricted_glottis 0": 0.5
      "r -constricted_glottis 0": 0.125 # sometimes just neutralise
      "r +constricted_glottis 0": 0.020833

  - condition: ", -resonant -nasal"
    except: {0: "+resonant"}
    prob: 0.6
    extras: {"-nasal 0": 0.9}
    resolve: {"r {constricted_glottis 1": 1}

  - condition: ", +constricted_glottis"
    extras: {"-fricative -nasal 0": 0.5}
    filter:
      condition: "-syllabic"
      extras: {"!dorsal +resonant -lateral -tap_or_trill 0": 0.833333, "-resonant 0": 0.166667, "-fricative -nasal 0": 0.083333}
    prob: 0.02 # only relevant if +constr exist
    contrast_probs:
      "+syllabic -constricted_glottis, +syllabic +constricted_glottis": 0
    direction: {"": 1, reverse: 0.5, both: 0.5}
    resolve: {"r +constricted_glottis 0": 1}
  # constricted glottis at a distance (DONE), dissimilation at a distance

  - condition: ", +constricted_glottis"
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.5}
    prob: 0.02 # only relevant if +constr exist
    contrast_probs:
      "-syllabic -constricted_glottis, -syllabic +constricted_glottis": 0
    direction: {"": 1, reverse: 0.5, both: 1.5}
    resolve: {"r +constricted_glottis 0": 1}

  - condition: ", labial"
    prob: 0.5
    resolve: {"r }labiodental 0": 1}

  - condition: "coronal, "
    prob: 0.2
    extras: {"-anterior 0": 0.5} # hm
    resolve: {"r {anterior <retroflex 1": 1}

  - condition: ", coronal"
    prob: 0.9
    extras: {"-resonant 1": 0.875, "!-fricative 1": 0.166667, "!-affricate 1": 0.916667}
    resolve: {"r }anterior >retroflex 0": 1}

  - condition: ", "
    filter:
      condition: "coronal -resonant -nasal"
      extras: {"!-affricate 0": 0.975, "+sibilant 0": 0.5, "-anterior 0": 0.083333, "+anterior 0": 0.083333}
    prob: 0.05
    direction: {"": 1, reverse: 0.5}
    resolve: 
      "r >sibilant >anterior >retroflex >laminal >lateral 0": 1

  - condition: "-resonant -nasal, coronal -resonant -nasal"
    prob: 0.25
    extras: {"+fricative 1": 0.95}
    resolve: {"r }sibilant 0": 1}

  # sibilant dissimilation, incl. at a distance, mostly for affricates??

  # [h] realised as voiceless glide, etc.
  - condition: "-dorsal -coronal -labial -constricted_glottis, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.033333
    extras: {"-voice 0": 0.5}
    direction: {"": 1, reverse: 0.083333, both: 0.5}
    resolve: {"r dorsal +resonant -lateral -tap_or_trill >low >high >front >back >ATR >round 0": 1}

  # Oh my, vowel assimilation rules.  Funny stuff.  Will there be diphthong winnowers aside from these?  
  # Anyway, these are composed a bit formulaically.
  # TODO: Raising rules should mostly require front-backness match.
  # glide lowth assim
  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic -high dorsal +resonant -lateral -tap_or_trill"
    prob: 0.166667
    extras: {"-ATR 1": 0.5, "!+low -front -back 1": 0.9}
    direction: {"": 1, reverse: 0.4, both: 0.4}
    resolve: {"r {low 1": 1}

  # V lowth assim
  - condition: "-high dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill"
    prob: 0.136111
    extras: {"-ATR 0": 0.5, "!+low -front -back 0": 0.9}
    direction: {"": 1, reverse: 0.2, both: 0.05}
    resolve: {"r }low 0": 1}

  # TODO: low dissimilation (things like /aj/ are favoured in fact)

  - condition: "dorsal, dorsal"
    except: {0: "dorsal +resonant -lateral -tap_or_trill", 1: "dorsal +resonant -lateral -tap_or_trill"}
    prob: 0.875
    extras: {"-resonant 0": 0.8, "-resonant 1": 0.333333}
    resolve: {"r }high 0": 1}

  # vowellowering near uvulars
  - condition: "dorsal +resonant -lateral -tap_or_trill, -high dorsal"
    except: {1: "dorsal +resonant -lateral -tap_or_trill"}
    prob: 0.657407 # raise when glide formation is in?
    extras: {"!+tap_or_trill 1": 0.666667}
    direction: {"": 35, reverse: 8, both: 32}
    resolve: {"r -high 0": 1}
  # chance of glide formation, high at that.  since I've made the changes apply to semivowels too, glidings will have to have enough knowledge for that

  # uvular > velar near high vowels, as in Ket
  - condition: "+resonant -lateral -tap_or_trill, -high dorsal -syllabic"
    prob: 0.025
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r {high 1": 1}

  # and the velar raising version.  high chance of glide formation
  - condition: "+syllabic -low, -syllabic dorsal +high"
    prob: 0.006667
    extras: {"+voice 1": 0.75, "+nasal 1": 0.333333, "-nasal 1": 0.25}
    resolve: {"r +high 0": 1}
  # (TODO: what of like that Gaelic [@] > [a] / _[x]?)

  # More formulaism, for vowels.
  # TODO: here and in the similar relateds, V raising by a high glide should mostly only apply when there's a front/back match.  ([ej] > [ij] is normal, [ew] > [iw] is surprising.)
  # glide height assim
  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic -low dorsal +resonant -lateral -tap_or_trill"
    prob: 0.14
    extras: {"+ATR 1": 0.5}
    direction: {"": 1, reverse: 0.4, both: 0.4}
    resolve: {"r {high 1": 1}

  # V height assim
  # TODO: reversed shd be large in non-prominent syllables only
  - condition: "-low dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill"
    prob: 0.07
    extras: {"+ATR 0": 0.5}
    direction: {"": 1, reverse: 0.166667, both: 0.041667}
    resolve: {"r }high 0": 1}

  # TODO: regarding Cs colouring Vs, sometimes this should only happen to weak vowels.

  # Do the tautosyllabicity thing on these next two groups.
  # Lowering before rhotics.
  - condition: "dorsal +resonant -lateral -tap_or_trill -high, +resonant"
    except: {1: "-coronal -tap_or_trill | +lateral -tap_or_trill"}
    prob: 0.027778
    extras: {"-labial 1": 0.5, "+tap_or_trill 1": 0.333333, "coronal -tap_or_trill 1": 0.166667, "-ATR 0": 0.8}
    direction: {"": 1, reverse: 0.05, both: 0.05}
    resolve: {"r +low 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill +high, +resonant"
    except: {1: "-coronal -tap_or_trill | +lateral -tap_or_trill"}
    prob: 0.027778
    extras: {"-labial 1": 0.5, "+tap_or_trill 1": 0.333333, "coronal -tap_or_trill 1": 0.166667}
    direction: {"": 1, reverse: 0.05, both: 0.05}
    resolve: {"r -high 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill +ATR, +resonant"
    except: {1: "-coronal -tap_or_trill | +lateral -tap_or_trill"}
    prob: 0.027778
    extras: {"-labial 1": 0.5, "+tap_or_trill 1": 0.333333, "coronal -tap_or_trill 1": 0.166667}
    direction: {"": 1, reverse: 0.05, both: 0.05}
    resolve: {"r -ATR 0": 1}

  # Raising before nasals.
  - condition: "dorsal +resonant -lateral -tap_or_trill +low, -syllabic +nasal"
    prob: 0.027778
    resolve: {"r -low 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill -low, -syllabic +nasal"
    prob: 0.027778
    resolve: {"r +high 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill -ATR, -syllabic +nasal"
    prob: 0.027778
    resolve: {"r +ATR 0": 1}

  # a rare resolution of [G\i]!
  - condition: "dorsal -high, +front"
    except: {0: "+resonant -lateral -tap_or_trill"}
    prob: 0.0075
    extras: {"+voice 0": 0.9, "dorsal +resonant -lateral -tap_or_trill 1": 0.25, "!-high 1": 0.5, "!+low 1": 0.75}
    direction: {"": 1, reverse: 0.333333, both: 1}
    resolve: {"r +tap_or_trill 0": 1}

  # velar > uvular near _nonfront_ vowels is what's seen, not nonhigh
  - condition: "dorsal -front, dorsal +resonant -lateral -tap_or_trill -front"
    except: {0: "+resonant -lateral -tap_or_trill"}
    prob: 0.017778
    extras: {"+back 1": 0.25, "-high 1": 0.75, "+low 1": 0.285714}
    direction: {"": 1, reverse: 0.6, both: 0.4}
    resolve: {"r -high 0": 1}

  # velar raising.  should have high chance of glide formation
  - condition: "+syllabic +low, -syllabic dorsal +high"
    prob: 0.0125
    extras: {"+voice 1": 0.666667, "+fricative 1": 0.333333, "+nasal 1": 0.25, "-nasal 1": 0.2}
    resolve: {"r -low -high 0": 1}

  # uvular lowering all the way to low
  - condition: "-high +syllabic, dorsal -syllabic -high"
    prob: 0.036458
    extras: {"-ATR 0": 0.4}
    direction: {"": 1, reverse: 0.5, both: 0.125}
    resolve: {"r +low 0": 1}

  # Alongside all the front assimilations below, consider the front -> nonback assimilations thereafter.  
  # The probabilities of these are smaller on account of the overlap.
  # We must use !-high instead of +high so that it doesn't restrict to dorsal.
  # Between true consonants, front assim is fairly likely, except
  # unlikely for true palatals (I think).
  - condition: "-syllabic, -syllabic"
    except: {0: "dorsal +resonant -lateral -tap_or_trill"}
    prob: 0.666667
    extras: {"-pharyngealised 0": 0.9, "!-high 0": 0.9, "!+front -palatalised_velar 0": 0.875, "# 1": 0.25}
    pause_phone: "-front"
    resolve: {"r }front 0": 1, "r -front 0": 0.125}

  - condition: "-syllabic, -syllabic"
    except: {1: "dorsal +resonant -lateral -tap_or_trill", 0: "dorsal +resonant -lateral -tap_or_trill"} # intentional asymmetry.
    prob: 0.111111
    extras: {"+front 0": 0.9375, "-pharyngealised 1": 0.9, "!-high 1": 0.9, "!+front -palatalised_velar 1": 0.875} # most perceptible pre-release, so shd rarely perseverate
    resolve: {"r {front 1": 1}

  - condition: "-syllabic, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.211853 # high, 'cause it comes up  dorsal coronal  sometimes.
    extras: {"+front 1": 0.9, "-pharyngealised 0": 0.9, "!-high 0": 0.9, "-labial -coronal 0": 0.571428, "-labial -dorsal 0": 0.375, "!-dorsal -coronal -labial 0": 0.5, "-round 0": 0.25, "+high 1": 0.5, "-low 1": 0.5, "!dorsal +resonant -lateral -tap_or_trill 0": 0.9, "!+front -palatalised_velar 0": 0.875}
    direction: {"": 7, reverse: 3, both: 1.5}
    resolve: {"r }front 0": 1}

  # front--uvular interaction.  not consolidated with the next 'cause mostly there won't be front uvulars and the rule will get voided
  - condition: "-syllabic -high, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.38
    extras: {"-resonant 0": 0.5}
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r {front 1": 1}

  # This change only does V fronting.
  - condition: "-syllabic +front, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.38
    extras: {"-back 1": 0.8}
    direction: {"": 1, reverse: 1, both: 0.333333}
    resolve: {"r +front 1": 1}

  # This one does both but only applies if there's a 
  # C palatality contrast; our tests for that are to exclude the glides.
  - condition: "-syllabic, dorsal +resonant -lateral -tap_or_trill"
    prob: 0
    contrast_probs:
      "-syllabic -dorsal -resonant -front, -syllabic -dorsal -resonant +front": 0.285
      "-syllabic -resonant -front, -syllabic -resonant +front": 0.035625
    extras: {"-back 1": 0.8}
    direction: {"": 1, reverse: 1, both: 0.333333}
    resolve: {"r {front 1": 1}

  # V front assim
  # reverse shd be larger in weak syllables
  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill"
    prob: 0.24
    extras: {"+front 1": 0.333333, "-back 0": 0.8}
    direction: {"": 1, reverse: 0.25, both: 0.083333}
    resolve: {"r }front 0": 1}

  - condition: "dorsal -resonant +front, dorsal -resonant +front"
    prob: 0.975
    resolve: {"r }palatalised_velar 0": 1}

  - condition: "-syllabic, -syllabic"
    except: {0: "dorsal +resonant -lateral -tap_or_trill +round"} 
    prob: 0.333333
    extras: {"+round 1": 0.6, "# 1": 0.25} 
    pause_phone: "-round"
    resolve: {"r }round 0": 1, "r -round 0": 0.125}

  - condition: "-syllabic, -syllabic"
    except: {1: "dorsal +resonant -lateral -tap_or_trill +round"} 
    prob: 0.125
    extras: {"+round 0": 0.96875} # most perceptible pre-release, so shd rarely perseverate
    resolve: {"r {round 1": 1}

  # C round assim from V
  - condition: "-syllabic, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.12
    extras: {"+round 1": 0.95, "-coronal -labial 0": 0.5, "dorsal 0": 0.4, "+high 1": 0.5, "-low 1": 0.5}
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r }round 0": 1}

  # voweloid round assim from C
  - condition: "-syllabic, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.0775
    extras: {"+round 0": 0.9875}
    direction: {"": 1, reverse: 1, both: 0.333333}
    resolve: {"r {round 1": 1}

  # Formulaism.
  # glide round assim
  - condition: "-syllabic dorsal +resonant -lateral -tap_or_trill, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.125514
    extras: {"+round 1": 0.95, "-low 0": 0.333333}
    direction: {"": 1, reverse: 0.75, both: 1.5}
    resolve: {"r }round 0": 1}

  # V round assim
  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill"
    prob: 0.130864
    extras: {"+round 1": 0.95, "-low 0": 0.333333}
    direction: {"": 1, reverse: 0.2, both: 0.05}
    resolve: {"r }round 0": 1}

  - condition: "-syllabic, -syllabic"
    except: {0: "dorsal +resonant -lateral -tap_or_trill"} # wish this could be probabilistic, but oh well.  glides are targeted by other rules
    prob: 0.05
    extras: {"!dorsal +back 0": 0.99, "# 1": 0.333333} # otherwise this more or less fronts velars in clusters
    pause_phone: "-back"
    resolve: {"r }back 0": 1, "r -back 0": 0.125}

  - condition: "-syllabic, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.02
    extras: {"+back 1": 0.9, "+high 1": 0.5, "-low 1": 0.5, "!dorsal +resonant -lateral -tap_or_trill 0": 0.9}
    direction: {"": 1, reverse: 1, both: 0.5}
    resolve: {"r }back 0": 1}

  # Again, back -> nonfront shd have most of the probability mass.
  - condition: "-syllabic, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.05
    extras: {"-dorsal 0": 0.875, "+back 0": 0.975} # more likely for genuine secondary articulates
    resolve: {"r {back 1": 1}

    # FIXME: this is No Good; we really just want it to _happen_ only in case of genuine secondary articulates
    # since that's messed up, we just have separately for uvulars here
  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal -high"
    prob: 0.325
    extras: {"-front 0": 0.975}
    direction: {"": 1, reverse: 0.4, both: 0.1}
    resolve: {"r }back 0": 1}
  # chance of glide formation

  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic"
    prob: 0.05
    extras: {"-dorsal 1": 0.875, "+back 1": 0.975}
    resolve: {"r }back 0": 1}

  # glide back assim
  # reverse larger in weak syllables
  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill"
    prob: 0.1925
    extras: {"-front 0": 0.8}
    direction: {"": 1, reverse: 0.25, both: 0.083333}
    resolve: {"r }back 0": 1}

  # back inducing central
  - condition: "-syllabic +back, +front dorsal +resonant -lateral -tap_or_trill"
    prob: 0.19
    extras: {"-dorsal 0": 0.975} # more likely for genuine secondary articulations
    direction: {"": 1, reverse: 1, both: 0.166667}
    resolve: {"r -front -back 1": 1}

  - condition: "+front dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill +back"
    prob: 0.2875
    direction: {"": 1, reverse: 0.2, both: 0.05}
    resolve: {"r -front -back 0": 1}

  # front inducing central
  # V to C.  doubled since half the time they revert to back.
  - condition: "-syllabic +back, dorsal +resonant -lateral -tap_or_trill +front"
    prob: 0.306667
    extras: {"+front 1": 0.9, "-pharyngealised 0": 0.9, "!+high 0": 0.9, "dorsal 0": 0.6, "-round 0": 0.25, "+high 1": 0.5, "-low 1": 0.5}
    direction: {"": 1, reverse: 0.666667, both: 0.666667}
    resolve: {"r -front -back 0": 1}

  # C to V
  - condition: "dorsal +resonant -lateral -tap_or_trill +back, -syllabic +front"
    prob: 0.191111
    resolve: {"r -front -back 0": 1}
    direction: {"": 1, reverse: 0.5, both: 0.166667}

  # V to Void
  - condition: "-syllabic +front, +back dorsal +resonant -lateral -tap_or_trill"
    prob: 0.066667
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r -front -back 1": 1}

  - condition: "+back dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill +front"
    prob: 0.2875
    direction: {"": 1, reverse: 0.2, both: 0.05}
    resolve: {"r -front -back 0": 1}

  - condition: "-syllabic dorsal +resonant -lateral -tap_or_trill, dorsal +resonant -lateral -tap_or_trill"
    prob: 0.19
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r }ATR 0": 1}

  # high to ATR formulaism, for vowels.
  # glide assim
  - condition: "-syllabic dorsal +resonant -lateral -tap_or_trill, dorsal +resonant -lateral -tap_or_trill +high"
    prob: 0.19
    direction: {"": 1, reverse: 1, both: 0.5}
    resolve: {"r +ATR 0": 1}

  # V assim
  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic dorsal +resonant -lateral -tap_or_trill +high"
    prob: 0.13
    direction: {"": 1, reverse: 0.333333, both: 0.083333}
    resolve: {"r +ATR 0": 1}

  # and the velar raising version.  high chance of glide formation
  - condition: "+syllabic -low, -syllabic dorsal +high"
    prob: 0.01
    extras: {"+voice 1": 0.75, "+nasal 1": 0.333333, "-nasal 1": 0.25}
    resolve: {"r +ATR 0": 1}


  # Laterality is one of these weird things that isn't actually really homologous at different major places.  So just this for now.
  # No special treatment for resonants.
  # TODO: apparently in these langs with velar laterals, some are related to velar + (colonal lateral) clusters.
  - condition: "coronal, coronal"
    prob: 0.075
    extras: {"-resonant 0": 0.5, "!+resonant +lateral 0": 0.8, "-nasal 0": 0.875, "+resonant 1": 0.25, "!-fricative 1": 0.5, "!-affricate 1": 0.5}
    resolve: {"r }lateral 0": 1}

  # lateral dissimilation at a distance

  # Retroflexion being cued by VC transitions mostly, it ought to assimilate left-to-right.  
  # We've written this twice so that we can avoid e.g. [t.tS)] > [t.tT)] or whatever, but it's ugly.
  - condition: "coronal +retroflex, coronal"
    prob: 0.975
    resolve: {"r +retroflex -anterior 1": 1}

  - condition: "coronal, coronal +retroflex"
    prob: 0.975
    extras: {"# 0": 0.083333}
    pause_phone: "+anterior -retroflex"
    resolve: {"r +retroflex -anterior 1": 1}

  - condition: "+syllabic, +retroflex"
    prob: 0.1
    direction: {"": 1, reverse: 0.016667, both: 0.016667}
      # reverse much lower 'cause of the VC transition salience
    resolve: {"r +retroflex 0": 1}

  - condition: ", +retroflex"
    prob: 0.36
    extras: {"coronal 0": 0.9875, "coronal -anterior 1": 0.4, "+syllabic 1": 0.5, "!dorsal +resonant -lateral -tap_or_trill 0": 0.8}
    direction: {"": 1, reverse: 1, both: 0.25}
    resolve: {"r coronal -anterior +retroflex 0": 1}

  # Per Blevins, laminality is also mostly cued by VC transitions.
  # But since laminality often determines anteriority, this is weird for us.
  - condition: "coronal, coronal"
    prob: 0.9375
    extras: {"# 1": 0.083333}
    pause_phone: "-laminal"
    direction: {"": 1, reverse: 1} # I don't know
    resolve: {"r }laminal 0": 1}

  - condition: "-dorsal -coronal -labial, +pharyngealised"
    prob: 0.36
    direction: {"": 1, reverse: 1, both: 1}
    resolve: {"r +pharyngealised 0": 1}

  - condition: ", +pharyngealised"
    prob: 0.19
    extras: {"-syllabic 1": 0.95, "+syllabic 0": 0.333333}
    direction: {"": 1, reverse: 1, both: 0.333333}
    resolve: {"r +pharyngealised 0": 1}

  - condition: ", +pharyngealised"
    filter:
      condition: "-syllabic"
      extras: {"!dorsal +resonant -lateral -tap_or_trill 0": 0.5}
    prob: 0.025 # only relevant if +phary exist
    contrast_probs:
      "+syllabic -pharyngealised, +syllabic +pharyngealised": 0
    direction: {"": 1, reverse: 0.5, both: 1.5}
    resolve: {"r +pharyngealised 0": 1}

  - condition: ", +pharyngealised"
    filter:
      condition: "+syllabic"
    prob: 0.025 # only relevant if +phary exist
    contrast_probs:
      "-syllabic -pharyngealised, -syllabic +pharyngealised": 0
    direction: {"": 0.5, reverse: 0.5, both: 1}
    resolve: {"r +pharyngealised 0": 1}

  # Counterstripping spread for [?].
  - condition: "-dorsal -coronal -labial +constricted_glottis, -resonant"
    except: {1: "-dorsal -coronal -labial"}
    prob: 0.0375
    extras: {"-nasal 1": 0.8, "-fricative 1": 0.5, "-voice 0": 0.75}
    resolve: {"r -resonant -fricative >dorsal >coronal >labial >front >back >round >retroflex >labiodental >anterior >laminal >high >palatalised_velar 0": 1}

  # Counterstripping spread for [h].
  - condition: "-dorsal -coronal -labial +spread_glottis, -resonant"
    except: {1: "-dorsal -coronal -labial"}
    prob: 0.1
    extras: {"-labial 1": 0.25, "-coronal -labial 1": 0.25, "-nasal 1": 0.5, "-fricative 1": 0.333333, "-voice 0": 0.75}
    resolve: {"r -resonant -fricative >dorsal >coronal >labial >front >back >round >retroflex >labiodental >anterior >laminal >high >palatalised_velar 0": 1}

  # Dorsal variant.
  - condition: "-dorsal -coronal -labial +spread_glottis, -resonant"
    except: {1: "-dorsal -coronal -labial"}
    prob: 0.15 
    extras: {"-labial 1": 0.25, "-coronal -labial 1": 0.25, "-nasal 1": 0.5, "-fricative 1": 0.333333, "-voice 0": 0.75, "-voice 1": 0.75, "# 1": 0.142857}
    resolve: {"r -resonant +fricative dorsal +back 0": 1}

  # And for after an obstruent.  Together with splitting this achieves [t_h] > [tx] sorts of things.
  - condition: "-resonant, -dorsal -coronal -labial +spread_glottis"
    except: {1: "-dorsal -coronal -labial"}
    prob: 0.125 
    extras: {"-labial 0": 0.166667, "-coronal -labial 1": 0.125, "-voice 0": 0.9375, "-fricative 0": 0.333333, "-voice 1": 0.75}
    resolve: {"r -resonant +fricative dorsal +back 1": 1}

  # TODO: there should be placelessising lenitions.  But perhaps make the syllable-final versions first.

  # Special vowel assimilation across a glottal.
  - condition: "+syllabic dorsal +resonant -lateral -tap_or_trill, +syllabic dorsal +resonant -lateral -tap_or_trill"
    filter:
      except: "-dorsal -coronal -labial"
    prob: 0.02
    contrast_probs:
      "-dorsal -coronal -labial -front, -dorsal -coronal -labial +front": 0
      "-dorsal -coronal -labial -back, -dorsal -coronal -labial +back": 0
      "-dorsal -coronal -labial -round, -dorsal -coronal -labial +round": 0
    resolve: 
      "r <low <high <front <back <round <ATR 1": 1
      "r >low >high >front >back >round >ATR 0": 0.25
  # also gliding form

  - condition: "+resonant, -long -resonant, +resonant" 
    prob: 0.224748
    extras: {"dorsal -lateral -tap_or_trill 0": 0.7, "dorsal -lateral -tap_or_trill 2": 0.7, "-nasal 1": 0.875, "+voice 1": 0.875, "-constricted_glottis 1": 0.875, "dorsal 1": 0.125, "# 2": 0.125, "## 2": 0.025, "-prenasalised 1": 0.5, "+affricate 1": 0.1}
    resolve: {"r +fricative 1": 1}

  # another rhotacism
  - condition: "+resonant, +resonant -syllabic -long, +resonant"
    prob: 0.02
    extras: {"coronal 1": 0.75, "!dorsal 1": 0.8}
    resolve: {"r +tap_or_trill 1": 1}

  # intervocalic tapping
  - condition: "+resonant, -resonant -long, +resonant"
    prob: 0.06
    extras: {"coronal 1": 0.833333, "!dorsal 1": 0.8, "-fricative 1": 0.975, "-affricate 1": 0.75, "+voice 1": 0.875, "dorsal -lateral -tap_or_trill 0": 0.333333, "dorsal -lateral -tap_or_trill 2": 0.333333}
    resolve: {"r +resonant +tap_or_trill 1": 1}

  # trill weakening
  - condition: "+resonant, +trill -syllabic -long, +resonant"
    prob: 0.04
    resolve: {"r -trill 1": 1}

  - condition: "+resonant, -dorsal -coronal -labial -long, +resonant"
    prob: 0.1
    extras: {"dorsal -lateral -tap_or_trill 0": 0.5, "dorsal -lateral -tap_or_trill 2": 0.5, "+spread_glottis 1": 0.25, "+constricted_glottis 1": 0.25}
    resolve: {"r -spread_glottis -constricted_glottis 1": 1}

  # TODO: some version of the Spanish [nm mn dn ...] > [lm mr dr ...] changes

  # TODO: together with the stop & fricative cluster changes, a homorganic assimilation (e.g. [fp] > [pp] and/or [pf] > [ff])

  - condition: "+nasal -resonant, -prenasalised"
    prob: 0.03
    extras: {"-fricative 1": 0.6}
    resolve: {"r +prenasalised 1": 1}

  - condition: "-nasal -resonant, +prenasalised"
    prob: 0.25
    resolve: {"r -prenasalised 1": 1}

  - condition: "+prenasalised, -resonant"
    prob: 0.2
    extras: {"# 1": 0.666667}
    resolve: {"r +nasal 0": 1}

  - condition: "-fricative, +high +resonant dorsal -lateral -tap_or_trill"
    prob: 0.00625
    extras: {"-nasal 0": 0.95, "+spread_glottis 0": 0.333333, "+ATR 1": 0.8, "labial 0": 0.3, "coronal 0": 0.15, "+syllabic 1": 0.4}
    resolve: {"r +affricate 0": 1}
    # I haven't let it select for dorsals alone, since high is directly greater closure for them

  - condition: "coronal -fricative, +high +resonant dorsal -lateral -tap_or_trill"
    prob: 0.04
    extras: {"-nasal 0": 0.95, "+spread_glottis 0": 0.333333, "+ATR 1": 0.8, "+front 1": 0.25, "-syllabic 1": 0.2}
    resolve: {"r +sibilant 0": 1}
    # any reason to differentiate by anterior?

  # (af)frication in [ka].  two ways 'cause affrication is differently suitable
  # TODO: matchedness in front-backness for several below
  - condition: "dorsal -resonant, dorsal +resonant -lateral -tap_or_trill -high"
    prob: 0.003703
    extras: {"+low 1": 0.666667, "-ATR 1": 0.75} 
    resolve: {"r +affricate 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill -high, dorsal -resonant"
    prob: 0.003703
    extras: {"+low 0": 0.666667, "-ATR 0": 0.75} 
    resolve: {"r +fricative 1": 1}

  # flipwise, kinds of lowering near dorsal fricatives (as in Gaelic)...
  - condition: "dorsal +resonant -lateral -tap_or_trill -high, dorsal +fricative"
    prob: 0.002778
    extras: {"+ATR 0": 0.933333}
    direction: {"": 1, reverse: 0.5, both: 1}
    resolve: {"r +low 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill -low, dorsal +fricative"
    prob: 0.002778
    direction: {"": 1, reverse: 0.5, both: 1}
    resolve: {"r -high 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill, dorsal +fricative"
    prob: 0.002778
    direction: {"": 1, reverse: 0.5, both: 1}
    resolve: {"r -ATR 0": 1}

  # ... or radical ones
  - condition: "dorsal +resonant -lateral -tap_or_trill -high, -dorsal -coronal -lateral +spread_glottis"
    prob: 0.002778
    extras: {"+ATR 0": 0.933333}
    direction: {"": 1, reverse: 0.5, both: 1}
    resolve: {"r +low 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill -low, -dorsal -coronal -lateral +spread_glottis"
    prob: 0.002778
    direction: {"": 1, reverse: 0.5, both: 1}
    resolve: {"r -high 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill, -dorsal -coronal -lateral +spread_glottis"
    prob: 0.002778
    direction: {"": 1, reverse: 0.5, both: 1}
    resolve: {"r -ATR 0": 1}


  # rhinoglottophilia
  - condition: "+voice, -dorsal -coronal -labial"
    prob: 0.025
    extras: {"+resonant 0": 0.5, "dorsal +resonant -lateral -tap_or_trill 0": 0.666667, "+syllabic 0": 0.2}
    direction: {"": 1, reverse: 1, both: 0.5}
    resolve: {"r +nasal 0": 1}

  # coronal Cs can spread to front(er) Vs. 
  - condition: "dorsal +resonant -lateral -tap_or_trill, coronal -retroflex"
    prob: 0.05
    extras: {"-anterior 1": 0.5}
    resolve: {"r -back 0": 1}

  - condition: "-syllabic, coronal -retroflex"
    prob: 0.04
    extras: {"!dorsal +resonant -lateral -tap_or_trill 1": 0.6, "-anterior 1": 0.5}
    resolve: {"r -back 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill, coronal -retroflex"
    prob: 0.033333
    extras: {"-back 0": 0.8, "-anterior 1": 0.5}
    resolve: {"r +front 0": 1}

  - condition: ", +front"
    extras: {"-back 0": 0.925, "+high 1": 0.75, "-low 1": 0.5}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.5}
    prob: 0.04
    contrast_probs:
      "-syllabic -resonant -front, -syllabic -resonant +front": 0
        # -resonant is a kluge so /j w/ doesn't interfere with having this
    direction: {"": 1, both: 0.025}
    resolve: {"r +front 0": 1}

  - condition: "-front, +front"
    extras: {"+high 1": 0.75, "-low 1": 0.5}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.5}
    prob: 0.04
    contrast_probs:
      "-syllabic -resonant -front, -syllabic -resonant +front": 0
    direction: {"": 1, both: 0.025}
    resolve: {"r -back 0": 1}

  # reported for Mat`ut_-uni@a, Dench 1995
  # TODO: the same for, like, front vowels disappearing pharyngealisation.
  # it's not really optimal that this goes to an affricate.
  - condition: "+front dorsal +resonant -lateral -tap_or_trill, "
    prob: 0.1
    extras: {"+high 0": 0.6, "-low 0": 0.9}
    resolve: {"r -retroflex 1": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill, +retroflex"
    prob: 0.444444
    direction: {"": 1, reverse: 0.5, both: 0.75}
    resolve: {"r -front 0": 1}

  - condition: "dorsal, labial"
    prob: 0.04
    extras: {"+resonant -lateral -tap_or_trill 0": 0.5, "-resonant 0": 0.4}
    direction: {"": 1, reverse: 0.333333, both: 0.166667}
    resolve: {"r +round 0": 1}

  - condition: ", +round"
    extras: {"+high 1": 0.75, "-low 1": 0.5}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.5}
    prob: 0.0125
    contrast_probs:
      "-syllabic -round, -syllabic +round": 0
    resolve: {"r +round 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic +pharyngealised"
    prob: 0.99
    direction: {"": 1, reverse: 1, both: 9}
    resolve: {"r -ATR 0": 1}

  # TODO: stress dependence for these ablaut rules
  - condition: ", "
    extras: {"-low 0": 0.5, "-low 1": 0.2, "-high 0": 0.5}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.8, "-low 0": 0.2, "-high 0": 0.3}
    prob: 0.02
    direction: {"": 1, both: 0.025}
    resolve: {"r }ATR 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic +pharyngealised"
    prob: 0.777778
    extras: {"+low 0": 0.25, "-front 0": 0.975}
    resolve: {"r +back 0": 1}
    direction: {"": 1, reverse: 0.25, both: 0.5}
  # chance of glide formation

  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic +pharyngealised"
    prob: 0.097778
    direction: {"": 1, reverse: 0.5, both: 0.5}
    resolve: {"r -front 0": 1}
  # chance of glide formation

  - condition: ", +back"
    extras: {"-front 0": 0.925, "+high 1": 0.125, "-low 1": 0.5}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.5}
    prob: 0.0075
    contrast_probs:
      "-syllabic -back, -syllabic +back": 0
    direction: {"": 1, both: 0.025}
    resolve: {"r +back 0": 1}

  - condition: "-back, +back"
    extras: {"+high 1": 0.125, "-low 1": 0.5}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"+syllabic 0": 0.5}
    prob: 0.0075
    contrast_probs:
      "-syllabic -back, -syllabic +back": 0
    direction: {"": 1, both: 0.025}
    resolve: {"r -front 0": 1}

  - condition: "-high dorsal +resonant -lateral -tap_or_trill, -syllabic +pharyngealised"
    prob: 0.45
    extras: {"-ATR 0": 0.4}
    direction: {"": 1, reverse: 0.5, both: 0.5}
    resolve: {"r +low 0": 1}
  # chance of glide formation

  - condition: "-high, +low"
    extras: {"-ATR 0": 0.5}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"!-syllabic -low 0": 0.2, "-high 0": 0.083333}
    prob: 0.016667
    resolve: {"r +low 0": 1}

  - condition: "-low, +low"
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"!-syllabic -low 0": 0.5}
    prob: 0.03125
    resolve: {"r -high 0": 1}

  - condition: "dorsal +resonant -lateral -tap_or_trill, -syllabic +pharyngealised"
    prob: 0.625
    direction: {"": 1, reverse: 0.333333, both: 0.5}
    resolve: {"r -high 0": 1}
  # chance of glide formation

  # pharyngealised V can uvularise velar C
  - condition: "dorsal -front, dorsal +resonant -lateral -tap_or_trill +pharyngealised"
    except: {0: "+resonant -lateral -tap_or_trill"}
    prob: 0.36
    direction: {"": 1, reverse: 1, both: 0.333333}
    resolve: {"r -high 0": 1}

  # TODO: some chance of homorganicity for these sort of things
  - condition: "-low, +high"
    extras: {"+ATR 0": 0.166667}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"!-syllabic +high 0": 0.5, "-low 0": 0.083333}
    prob: 0.016667
    resolve: {"r +high 0": 1}

  - condition: "-high, +high"
    extras: {"!-front -back 0": 0.75}
    filter:
      condition: "dorsal +resonant -lateral -tap_or_trill"
      extras: {"!-syllabic +high 0": 0.5}
    prob: 0.011111
    resolve: {"r -low 0": 1}

  - condition: "+syllabic, -syllabic +voice"
    except: {1: "dorsal +resonant -lateral -tap_or_trill"}
    prob: 0.008333
    extras: {"!-resonant -nasal 1": 0.333333, "-resonant 1": 0.5, "-nasal 1": 0.166667, "+fricative 1": 0.333333}
    resolve: {"r +long 0": 1}


  # Here, I suppose, start the changes not viewable as assimilations.

  # Gestural hiding.
  - condition: "-resonant, -nasal, "
    except: {1: "+resonant | +fricative | +affricate"}
    prob: 0.416666 # raised for the radical-only form
    extras: {"-dorsal -labial 1": 0.666667, "-dorsal -coronal -labial 1": 0.6, "-nasal 0": 0.333333, "-fricative 0": 0.5, "-resonant 2": 0.9, "-nasal 2": 0.25, "-fricative 2": 0.5, "# 0": 0.333333, "# 2": 0.333333}
    resolve: {"delete 1": 1}


# msd -- here begin single-phoneme conditions

  # Glottals often have nasality passthrough, but they don't go nasal themselves.  Thus this shouldn't be phonemic_only.
  # Split resolution for the product of nasals that go placeless (per Blevins this is often [N], or a nasal glide.)
  - condition: "-dorsal -coronal -labial +nasal"
    prob: 0.999
    flip:
      nasal: 63
    split:
      - if: "-nasal 0"
        condition: "-constricted_glottis -spread_glottis -pharyngealised"
        prob: 1
        flip:
          dorsal: 1.5
        univalent_addition: "+resonant"

  # Nearly always, coloured radicals can be resurrected, always to resonants.
  # Deleting [j] and [w], then, is best done by _actual_ deletion.
  # However, colored realisable radicals [? h] etc are likelier to stay.
  #
  # Ultimately, what happens when a coarticulated C falls should depend
  # on dissimilation-type factors; the coarticulation should not be left
  # if it was predictable; it often should if it wasn't.

  - condition: "-dorsal -coronal -labial +front"
    prob: 0.925
    extras: {"-constricted_glottis -spread_glottis 0": 0.666667}
    resolve: {"r +dorsal +resonant 0": 1}
    split: # colored [h] has a special tendency to go to _fricatives_
      - condition: "+spread_glottis"
        prob: 0.666667
        resolve: {"r +dorsal +fricative 0": 1}

  - condition: "-dorsal -coronal -labial +round"
    prob: 0.925
    extras: {"-constricted_glottis -spread_glottis 0": 0.666667}
    resolve: {"r +dorsal +resonant 0": 1}
    split:
      - condition: "+spread_glottis"
        prob: 0.666667
        resolve: {"r +dorsal +fricative 0": 1}

  - condition: "coronal dorsal"
    prob: 0.9975
    prevented_by: alveolar_velar
    flip:
      dorsal: 2
    # there should never be any reason to outright delete a coarticulate.  
    # I think loops aren't a problem here

  - condition: "labial dorsal"
    prob: 0.875
    prevented_by: labial_velar
    flip:
      dorsal: 2
    split:
      - if: "-dorsal 0"
        condition: "+resonant"
        prob: 1
        flip:
          labial: 15

  - condition: "labial coronal"
    prob: 0.95 # lowered a bit
    prevented_by: labial_alveolar

  # Coarticulate fricatives are quite selected against.
  # For now just one case; is that all we actually need?
  # TODO: note that Yeli Dnye, which has labial-coronals, has only [B B_j G] for its fricative inventory, but has [D_oB_o) lB_o) jB_o)]!
  - condition: "labial +fricative"
    except: {0: "-coronal -dorsal"}
    prob: 0.99
    related_weight:
      "-dorsal -coronal -labial": 0

  - condition: "labial dorsal +resonant"
    prob: 0.98
    related_weight:
      "-dorsal -coronal -labial": 0
    flip:
      labial: 15

  - condition: "coronal dorsal +resonant"
    prob: 0.98
    flip:
      dorsal: 20 # we want these to yield coarticulates thus
    related_weight:
      "-dorsal -coronal -labial": 0

  # +high +low and +front +back are dealt with by antitheticality.

  - condition: "+retroflex -coronal -dorsal"
    prob: 1

  - condition: "+retroflex +anterior"
    prob: 1
    flip:
      retroflex: 2.5 # otherwise it's hard to front retroflex things

  - condition: "+retroflex dorsal -resonant"
    prob: 1

  # The "resonant: 0"s here should be left in!  They prevent bad resolutions of rules with extra features added.

  - condition: "+low +ATR"
    prob: 1
    flip:
      resonant: 0
      low: 0
    related_weight:
      "": 0

  # Low vowel contrasts should be rare.  
  - condition: "+low +front"
    prob: 0.833333
    flip:
      resonant: 0

  - condition: "+low -back +round"
    prob: 0.99
    flip:
      resonant: 0
      low: 0.25
      round: 2

  - condition: "+low +back"
    prob: 0.2
    flip:
      resonant: 0

  # This isn't quite aligned with how rounding differences are generated:
  # they condition on front, this on back.  So this might cut down /u\/
  # by too much...
  - condition: "dorsal +resonant -lateral -tap_or_trill -back +round"
    prob: 0.75
    prevented_by: front_rounded
    flip:
      dorsal: 0
      resonant: 0
      lateral: 0
      tap_or_trill: 0
      #back: 1
      round: 2
    related_weight:
      "+nasal": 0
      "+fricative": 0
      "coronal": 0.01
    split:
      - condition: "-syllabic"
        prob: 0.25
        flip:
          dorsal: 0
          resonant: 0.125
          lateral: 0
          tap_or_trill: 0
          #back: 1
          round: 2
        related_weight:
          "+nasal": 0
          "+fricative": 0.1875 # times 2
          "coronal": 0.01

  - condition: "dorsal +resonant -lateral -tap_or_trill +back -low -round"
    prob: 0.5
    prevented_by: back_unrounded
    flip:
      dorsal: 0
      resonant: 0
      lateral: 0
      tap_or_trill: 0
      #back: 1
      round: 2
      low: 0.125 # high to low is pretty horrid.
    related_weight:
      "+nasal": 0
      "+fricative": 0
      "coronal": 0.01
    split: # TODO: does the other rule against this stuff suffice?
      - condition: "-syllabic"
        prob: 0.25 
        flip:
          dorsal: 2
          # I'm going equal for [w] and [j]
          back: 0
          resonant: 0.025
          lateral: 0.025
          tap_or_trill: 0.025
        related_weight:
          "+fricative": 0.2 # times 2
          "coronal": 0.2

  # Writing "-low" here is a kluge, but it prevents *"+low +ATR" and
  # *"+high -ATR" from being thought to conflict.
  # (I probably ought to have more systematic machinery for this.)
  - condition: "+high -low -ATR"
    prob: 0.75
    flip:
      resonant: 0
      low: 0

  # central mid vowels are a little uncommon as phonemes;
  # they're of course prevalent as reductions
  - condition: "+syllabic dorsal -high -low -front -back"
    prob: 0.625
    phonemic_only: true
    flip:
      resonant: 0
      dorsal: 0
      low: 2.5
      high: 1.5

  # gap at /u/.  not at all frequent, but there seem to be lots of examples
  # of changes to such vowels so one assumes the position just tends
  # to get refilled quickly
  - condition: "+syllabic dorsal +high +back +round"
    prob: 0.025
    flip:
      dorsal: 0

  # this rule is not enough in theory: we shouldn't have low non-V-oid resonants either.  but non-V-oid isn't a feature :-(
  # split resolutions?  ... to what end?
  - condition: "+low -resonant"
    prob: 1
    flip:
      resonant: 0
    # This used to have a related_weight, but that blocked the pharyngealisation outcome, and I don't know what it was good for.

  # Cast for vowels separately.  TODO: unify and split-resolve.
  - condition: "-syllabic +front +round"
    prob: 0.6
    flip:
      front: 2
      round: 2
    related_weight:
      "labial": 0.2 # for 0.6

  # For dorsals actually back is the unmarked one.  Flipping back is strong so that rounded dorsals resist fronting.
  - condition: "-syllabic dorsal -back +round"
    prob: 0.8
    flip:
      dorsal: 0
      back: 6
      round: 2
    related_weight:
      "labial": 0.01

  - condition: "+nasal +affricate"
    prob: 0.9975
    flip:
      affricate: 4
      nasal: 0 # otherwise we get silly resolutions like voiced affricates but no voiced stops
    related_weight:
      "+resonant": 0.01

  - condition: "+nasal +fricative"
    prob: 0.9975
    flip:
      fricative: 5
    related_weight:
      "-dorsal -coronal -labial": 0

  - condition: "-resonant +nasal +lateral"
    prob: 0.9975
    flip:
      lateral: 50
    related_weight:
      "-nasal +resonant": 20 # nasal > resonant, I hope

  - condition: "+prenasalised +fricative"
    prob: 0.85
    related_weight:
      "+resonant": 0.01
      "-dorsal -coronal -labial": 0

  # We used to see vl resonant > stop too much.  But I think I curbed that somehow.
  - condition: "+resonant -voice"
    prob: 0.9375
    phonemic_only: true
    prevented_by: voiceless_resonant
    flip:
      voice: 3
      resonant: 0.5 # which goes to a stop, for consonants
    related_weight: # These are multiplicative.
      # 2 to a fricative
      "+nasal": 0
    split:
      - condition: "+syllabic"
        prob: 1
        resolve:
          "free 0": 1.5
          "delete 0": 1 # this is newish.  careful now
        flip:
          voice: 1.333333
          resonant: 0 # catch it in the relateds
        related_weight:
          "+nasal": 0
          "+fricative": 0.083333 # times 2

  # Identical version for sound changes.
  - condition: "+resonant -voice"
    prob: 0.333333
    prevented_by: voiceless_resonant
    flip:
      voice: 3
      resonant: 0.5 # which goes to a stop, for consonants
      # and should be 2 to a fricative
    related_weight: # These are multiplicative.
      "+nasal": 0

  - condition: "+nasal -voice -resonant"
    prob: 0.95
    flip:
      voice: 6
      resonant: 0
    related_weight:
      "+resonant": 0

  - condition: "+prenasalised -voice"
    prob: 0.85
    related_weight:
      "+nasal": 0.05

  - condition: "+implosive -voice" 
    prob: 0.925
    flip:
      voice: 12
      implosive: 12

  - condition: "+implosive -voice +constricted_glottis" 
    prob: 1

  - condition: "+implosive +spread_glottis"
    prob: 0.95 # who knows

  - condition: "+implosive +affricate"
    prob: 0.9975
    flip:
      implosive: 0.1
    related_weight:
      "+fricative": 0

  - condition: "+implosive +fricative"
    prob: 0.9975
    flip:
      implosive: 0.1
    related_weight:
      "-dorsal -coronal -labial": 0

  # creaky and uncreaky implosives shouldn't contrast.
  - condition: "+implosive +voice -constricted_glottis"
    prob: 0
    contrast_probs:
      "-constricted_glottis, +constricted_glottis": 0.983333
    resolve: {"r +constricted_glottis 0": 1}

  # impossible radicals.  first the nothing-at-all consonant.
  # we'd like it if like the [j w] rules can tend to come before this.
  - condition: "-dorsal -coronal -labial -constricted_glottis -spread_glottis -pharyngealised"
    prob: 1
    resolve: {"delete 0": 14}
    flip:
      constricted_glottis: 0
      spread_glottis: 0
      pharyngealised: 0

  # voiced glottal stop
  - condition: "-dorsal -coronal -labial +voice +constricted_glottis"
    prob: 1
    flip:
      voice: 2.5
      constricted_glottis: 1

  # no special constraint against [h\]; the general one on breathiness subsumes it

  # [h_?\] is mostly supposed to be [X\].
  - condition: "-dorsal -coronal -labial +spread_glottis +pharyngealised"
    prob: 0.857142
    flip:
      spread_glottis: 50

  # [-resonant] here so that [?~ h~] aren't selected against
  - condition: "-voice +spread_glottis +nasal"
    prob: 0.9995
    flip:
      spread_glottis: 31

  - condition: "-voice +constricted_glottis +nasal"
    prob: 0.9995
    flip:
      voice: 31

  - condition: "-voice +spread_glottis +resonant"
    prob: 0.9995
    flip:
      spread_glottis: 31
    related_weight:
      "": 0.1
      "+fricative": 0
      "+nasal": 0

  # coloured glottal stop goes here first; we want to get creaky resonants from it.
  - condition: "-voice +constricted_glottis +resonant"
    prob: 0.9995
    flip:
      voice: 31
    related_weight:
      "": 0.1
      "+fricative": 0
      "+nasal": 0

  - condition: "+spread_glottis +constricted_glottis"
    prob: 1
    related_weight:
      "": 0

  # Voiced phonation rules.  

  - condition: "-syllabic +voice +constricted_glottis"
    except: {0: "+implosive"}
    prob: 0.975
    prevented_by: creaky_sonorant
    resolve: {"r -constricted_glottis 0": 1}
    split:
      - condition: "-fricative -nasal"
        prob: 1
        flip:
          voice: 2.5
          constricted_glottis: 2.5
          implosive: 1

  - condition: "-syllabic +voice +spread_glottis"
    prob: 0.975
    prevented_by: breathy_sonorant
    flip:
      voice: 0
    split:
      - condition: "-fricative"
        prob: 1
        # but no flip; [b_h] > [p_h] is common

  - condition: "+fricative +constricted_glottis"
    prob: 0.9
    flip:
      constricted_glottis: 10
      fricative: 0.125
    related_weight:
      "+affricate": 20 # product 10/3. [s_>] to [ts)_>] type things can happen
      "+resonant": 0
      "-dorsal -coronal -labial": 0.166667

  - condition: "+fricative +spread_glottis"
    prob: 0.975
    flip:
      spread_glottis: 15
      fricative: 0.125
    related_weight:
      "+resonant": 0.05
      "-dorsal -coronal -lateral": 0.2

  # Is initial_prob really a sensible handling?  original prob was 0.45.
  # It seems clear in any case that [N] needs some sort of special handling.
  # Before a velar it should mostly be left alone; it's not clear whether
  # for this we want a resolution depending on surrounding sounds.
  # (If so, then its ordering has to be strange to prevent screwing with
  # a persistent nasal assimilation rule: first, do whatever to it
  # where not before a dorsal C; then nonpersistently send it to
  # coronal before a dorsal C.)
  # It's likely that the main eliminator of [N] shd be syllable 
  # position-sensitive changes.
  - condition: "dorsal +nasal -resonant" # [N]
    initial_prob: 0.625 # inflated but perhaps what we need
    prob: 0.2
    phonemic_only: true # this in conjunction with an onset change...?
    resolve:
      "free 0": 3
      "delete 0": 0.03125
    flip:
      nasal: 0.25

  # This is *not* identical to the below change, because of the weightings.
  # We disfavour generated e.g. /w~/ going to /N_w/ 'cause that
  # makes too many /N_w/, though it's not clear if the present
  # solution achieves anything.
  #
  # The [N] change must precede this; better unavoidable [M\]s than 
  # unavoidable nasalised glides.
  - condition: "-syllabic +nasal +resonant"
    prob: 0.9875
    phonemic_only: true
    flip:
      resonant: 0.5
      nasal: 2
    related_weight:
      "+fricative": 0.05

  - condition: "+nasal +resonant"
    except: {0: "-high"}
    prob: 0.5
    flip:
      nasal: 2
    split: 
      - condition: "+syllabic +high" # lean, hoping to avoid missing things due to being before their filling-in
        prob: 1
        flip:
          high: 64
          nasal: 64
          dorsal: 0
          resonant: 0
          lateral: 0
          tap_or_trill: 0
        related_weight:
          "": 0.1

  # This change, anyway, should be fairly likely, 'cause it's the route by which I mean to do V~ > VN breaking.  -- Actually, no, there will probably be two breakings.  
  - condition: "-syllabic +nasal +resonant" 
    prob: 0.444444
    flip:
      resonant: 4 # for the V~ > VN thing
    related_weight:
      "+fricative": 0.05

  - condition: "+voice +fricative"
    prob: 0.53125
    flip:
      voice: 2
    related_weight:
      "-dorsal -coronal -labial": 0.25

  # two affricate types with a stronger tendency to frication
  - condition: "+voice +affricate"
    prob: 0.2

  - condition: "+spread_glottis +affricate"
    prob: 0.2

  - condition: "-anterior +trill"
    prob: 0.958333
    flip:
      anterior: 2.5

  - condition: "+lateral +trill"
    prob: 1

  - condition: "+lateral +tap_or_trill"
    prob: 0.925 # should this really be more like aversion of contrasts with [l] or [4]?
    flip:
      lateral: 4
      tap_or_trill: 4
    related_weight:
      "-affricate": 0.02

  # The negative major places here are to accommodate partially lateral coarticulates.  They're a kluge, just as handling lateral with a single feature is.
  - condition: "labial +lateral -coronal -dorsal"
    prob: 1
    flip:
      labial: 0.01

  - condition: "-high +lateral"
    prob: 0.9975

  - condition: "+sibilant +lateral"
    prob: 1
    flip:
      sibilant: 10

  - condition: "+long +tap_or_trill -trill"
    prob: 1
    resolve: {"r +trill 0": 1}

  - condition: "labial +tap_or_trill"
    prob: 0.966667
    flip:
      labial: 0.03125

  - condition: "+laminal +tap_or_trill"
    prob: 0.993333
    resolve:
      "free 0": 1
      "r -laminal -front 0": 23
    related_weight:
      "+front": 0 # against loops

  # a gap that seems to come up.  perhaps implied enough by the laminality stuff?
  - condition: "coronal +tap_or_trill +front"
    prob: 0.333333

  - condition: "dorsal +tap_or_trill"
    prob: 0.666667 # not higher 'cause, by the below, we don't get them if we haven't hit uvular

  - condition: "dorsal +tap_or_trill +high"
    prob: 1
    flip:
      dorsal: 2
      high: 2

  - condition: "+resonant dorsal -high +tap_or_trill -trill"
    prob: 0.75
    flip:
      resonant: 0.25
      dorsal: 0.125
      high: 0.125
      trill: 8

  # non-high glides.  
  # When I put the sonority rules in, to syllabify glides next to a
  # higher thing, the role of this rule should become minor.

  # (Actually, hm.  If there has just been a big producing of glides by CV
  # contextual metathesis, one might want to syllabify every glide, even 
  # high ones.)
  - condition: "-syllabic +resonant -lateral -tap_or_trill -high"
    prob: 0.95
    phonemic_only: true
    flip:
      high: 5
      resonant: 0
      lateral: 0
      tap_or_trill: 0
    related_weight:
      "": 0.05

  # front uvulars bad, but [e] etc. okay of course.
  # don't favour flipping -back now that uvulars don't _get_ palatalised so much
  - condition: "-resonant -high -back"
    prob: 0.98
    flip:
      back: 15

  - condition: "+tap_or_trill -high -back"
    prob: 0.98
    flip:
      back: 15

  # lateral uvulars already taken care of, above

  - condition: "-dorsal +back" 
    prob: 0.95
    phonemic_only: true
    flip:
      dorsal: 0
      back: 50
    related_weight:
      "": 0

  # identical version for sound changes
  # TODO: consolidate such identical versions, in general?
  - condition: "-dorsal +back" 
    prob: 0.857142
    flip:
      dorsal: 0
      back: 50
    related_weight:
      "": 0

  - condition: "+pharyngealised +front"
    except: {0: "dorsal +resonant -lateral -tap_or_trill"}
    prob: 0.95

  - condition: "+pharyngealised +ATR"
    prob: 0.95

  - condition: "labial +round"
    prob: 0.8
    flip:
      labial: 0
      round: 8
      # 1 to labiovelars
    split:
      - condition: "+resonant"
        prob: 1
        flip:
          # 1 to unround
          # 3 to labiovelars

  - condition: "-laminal -anterior -retroflex"
    prob: 0.75

  - condition: "-laminal +front" # framed correctly?
    prob: 0.875
    flip:
      laminal: 7

  # palatalised retroflex Cs are actually impossible, according to
  # per Silke Hamann _The Phonetics and Phonology of Retroflexes_.
  - condition: "+retroflex +front -syllabic"
    prob: 1
    flip:
      front: 5

  - condition: "+retroflex +front"
    prob: 0.875

  - condition: "dorsal +retroflex +back"
    prob: 0.875
    flip:
      dorsal: 0

  # plosive types that are usually affricates.  
  - condition: "+sibilant -affricate +nasal"
    prob: 1
    flip:
      sibilant: 8
      affricate: 0 # this can cause a loop.
      nasal: 0
    related_weight:
      "": 0.05

  - condition: "+sibilant -affricate -nasal"
    prob: 1 # sibilancy isn't meaningful on a stop
    flip:
      affricate: 8
      nasal: 0

  - condition: "-sibilant -lateral +affricate"
    prob: 0.8
    flip:
      lateral: 0.666667
    related_weight:
      "+fricative": 0.05 # not like these are good kinds of fricatives either
    split:
      - if: "+lateral 0"
        condition: "-anterior"
        prob: 0.9
        flip:
          lateral: 0.020833
        related_weight:
          "+fricative": 0.05

  - condition: "-sibilant -lateral +fricative"
    prob: 0.8
    flip:
      lateral: 0.666667
    split:
      - if: "+lateral 0"
        condition: "-anterior"
        prob: 0.9
        flip:
          lateral: 0.020833

  # Same for posteriors but way stronger.  
  - condition: "-sibilant -anterior -lateral +affricate"
    prob: 0.993333
    flip:
      lateral: 0
      affricate: 0.125
      anterior: 0.125
      sibilant: 16
    related_weight:
      "": 0.0625

  - condition: "-sibilant -anterior -lateral +fricative"
    prob: 0.993333
    flip:
      lateral: 0
      fricative: 0.125
      anterior: 0.125
      sibilant: 16
    related_weight:
      "": 0.0625

  - condition: "-anterior -retroflex -affricate -nasal"
    prob: 0.925
    flip:
      affricate: 12
      retroflex: 0.2
      nasal: 0

  - condition: "+lateral -affricate -resonant -nasal" # relying on _requires_ here
    prob: 0.9875
    flip:
      affricate: 8
      nasal: 0

  # The ordinary-but-still-often-absent stuff is mostly here.
  - condition: "-dorsal -coronal -labial +constricted_glottis"
    prob: 0.5
    resolve: {"delete 0": 14}

  - condition: "-dorsal -coronal -labial +spread_glottis"
    prob: 0.5
    resolve: {"delete 0": 14}

  - condition: "-syllabic dorsal -front -back"
    prob: 0.999
    phonemic_only: true
    flip:
      dorsal: 0 # and they should resolve one side or the other

  - condition: "+palatalised_velar -front"
    prob: 1
    flip:
      palatalised_velar: 0
      front: 0
      # but shd be 4 to +back

  - condition: "+resonant -anterior -retroflex"
    prob: 0.95
    flip:
      resonant: 0
      retroflex: 0.1
    related_weight:
      "+nasal": 0
      "+fricative": 0.05
    split:
      - if: "dorsal 0"
        condition: "+tap_or_trill"
        prob: 0.8
        flip:
          resonant: 0
          retroflex: 0
        related_weight:
          "+nasal": 0
          "+fricative": 0.1
          "dorsal": 0 # this is the key difference.

  - condition: "+nasal -resonant -anterior -retroflex"
    prob: 0.95
    phonemic_only: true
    flip:
      nasal: 0
      resonant: 0
      retroflex: 0.1
    related_weight:
      "dorsal": 1.5
      "+resonant": 0

  - condition: "dorsal -resonant -nasal +front"
    prob: 0.4
    flip:
      dorsal: 0.01
      resonant: 0
      nasal: 0

  # The hope here is to get [s S] type allophony generated more.
  - condition: "coronal +anterior +front"
    initial_prob: 0.25
    prob: 0
    persist: 1
    resolve: {"r -anterior 1": 1}

  - condition: "labial +resonant"
    prob: 0.9
    flip:
      resonant: 0.25

  - condition: "coronal +resonant -lateral -tap_or_trill"
    prob: 0.857143
    flip:
      resonant: 0.25
      lateral: 1.5
      tap_or_trill: 1.5
    split:
      - condition: "-anterior -retroflex"
        prob: 0.666667
        flip:
          resonant: 0.25
          lateral: 0.5
          tap_or_trill: 0.25
          # dorsal wins the big stakes here

  - condition: "coronal +resonant"
    prob: 0.041

  # the [M\] gap.  loss and +front and +round are the favoured resolutions
  # See also the analogous change above which doesn't care about syllabicity.
  - condition: "-syllabic dorsal +resonant -lateral -tap_or_trill -front -round" 
    prob: 0.925
    extras: {"-low 0": 0.9, "+high 0": 0.142857} # [a] glides aren't bad for _this_ reason
    resolve:
      "free 0": 1
      "delete 0": 0.8
    flip:
      dorsal: 2
      # I'm aiming for equal for [w] and [j]
      back: 0
      resonant: 0.0375
      lateral: 0.0125
      tap_or_trill: 0.0125
      low: 0
    related_weight:
      "+fricative": 0.2 # times 2
      "coronal": 0.2
    split:
      # It is conceivable that back ones could round while mid ones do their own thing.
      - condition: "+back"
        prob: 0.125
        resolve: {"r +round 0": 1}
      # Next to a vowel, secondary [M\] frequently assimilates.
      # Note that, since we short-circuit generation of the set of phonemes,
      # this has no effect on that set, as is desirable.
      - unless_deletion: 0
        offset: -1
        condition: "dorsal +resonant -lateral -tap_or_trill, "
        prob: 0.833333
        direction: {"": 1, reverse: 0.083333, both: 0.333333}
        resolve: {"r <front <back <round 0": 1}

  # the gap for semivowels of all sorts.
  - condition: "-syllabic dorsal +resonant -lateral -tap_or_trill"
    prob: 0.2 # was 0.125
    resolve:
      "free 0": 1
      "delete 0": 2
    flip:
      dorsal: 0 # these varmints are resistant to placelessising, now
      resonant: 0.25 # 'cause this goes straight to stops
    related_weight:
      "": 0.5

  - condition: "dorsal +implosive"
    prob: 0.9

  - condition: "labial -voice +constricted_glottis"
    prob: 0.333333

  - condition: "labial +fricative"
    prob: 0.375
    flip:
      fricative: 0.25 # fric > stop fortition is relatively uncommon

  - condition: "dorsal +fricative"
    prob: 0.55
    flip:
      fricative: 0.25
      dorsal: 3 # /x/ > /h/ is particularly common

  - condition: "labial +affricate"
    prob: 0.925
    flip:
      labial: 0

  - condition: "dorsal +affricate"
    prob: 0.925
    flip:
      dorsal: 0

  - condition: "labial -voice -fricative" # the [p] gap
    prob: 0.083333
    flip:
      voice: 0.033333
      fricative: 4

  - condition: "coronal +voice -resonant -nasal" # low-frequency [d] gap
    prob: 0.009259
    resolve: {"r +resonant 1": 1}

  - condition: "dorsal +voice -fricative -nasal" # the [g] gap
    prob: 0.111111
    flip:
      voice: 0.333333

  - condition: "dorsal +voice -fricative -high -resonant" # a special one for [G\]
    prob: 0.3
    flip:
      voice: 0.333333
      fricative: 2.5

  - condition: "dorsal +voice +fricative"
    prob: 0.142857
    flip:
      voice: 0.03125 # David
      fricative: 0.5
      resonant: 1.5

  # See comments on "labial +lateral" above.
  - condition: "dorsal +lateral"
    except: {0: "coronal"} # necessary in case undefined for coronal hasn't been filled yet
    initial_prob: 0.99 # there should be very little generated [L\], but getting [L] from palatoalv lateral shd be okay.
    prob: 0.925
    flip:
      lateral: 10
      dorsal: 2
      # by way of biassing against > fricative

  # a bit more gappedness of voiced lateral obstruents; probably only correct for generation
  - condition: "+lateral -resonant +voice"
    prob: 0.3
    phonemic_only: true
    flip:
      resonant: 4
      voice: 1.5

  # This rule is only to fix a preponderance of [tK)_-] things in v.5.
  # Is it still necessary?
  - condition: "-anterior +lateral -resonant"
    initial_prob: 0.9375
    prob: 0
    flip:
      resonant: 0

  # the modern Greek rule
  - condition: "+voice -fricative -nasal -prenasalised -implosive"
    prob: 0.025
    flip:
      nasal: 0.05 # mostly go through prenasal

  # and an occasional language has creakies but no ejectives.  
  - condition: "-voice +constricted_glottis"
    prob: 0.1
    flip:
      voice: 0.333333 # I think ejectives do go voiced sometimes.
      constricted_glottis: 1.5





# Not in yet: 
# - preaspirates (mean to do purely as situational breaking of aspirates)
# - prestopping (situational reinforcement w/ a new segment)
# - prenasalised resonants(!)
# - nonejective glottalised voiceless stops
# - unreleased stops (never contrastive > not to be represented?) (should this do anything to fricatives?)
# - superhigh ~ fricative vowels (and note their distribution in Mandarin) (these are representable, it's just that their change infrastructure isn't there.  they yield 'noisy' Cs and C transitions, and should have a fair chance just to go back to resonant vowels) (note that, in many natlang examples, velarity isn't kept; [1 M] tend to behave as place-unmarked Cs in particular)
# - fricative trills
# - whistled sibilants
# - subapicals, and laminal "closed" postalveolars
# - epiglottals, and vowels coarticulated with them = strident Vs.  epiglottals draw Vs towards [&], not [A]
# - voiceless laryngealised obstruents distinct from ejectives
# - linguolabials
# - generation of syllabic Cs
# - clicks
# Then the big ones: tone; stress; length and autosegmentalish timing.

# For syllabic Cs, perhaps we should really just generate deleting the vowel in suitable circumstances.

# things: *sonority increase across a syllable; *tl.
# Glottal stops in word-extremal position across an obstruent sorts of things also seem dispreferred.
# resonant+glide seems to like to metathesise, though sometimes glide fortition.
# Note also that [dn] > [nd] type metatheses do happen (e.g. Span/Port, Oromo)!

# Coronal to velar after high vowels is attested.  (How to make this perseverate over NC clusters?  A tier??)  Also make sure [t] <> [k] by previous vowel frontness is in.
# velar frication near low. ???DONE I forget.

